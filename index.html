<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ghosty Legend: Full Update</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #000; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; font-family: 'Press Start 2P', cursive; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #0a0a1a url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/background-night.png') bottom center; background-size: cover; overflow: hidden; }
        
        /* –ü—Ä–∏–∑—Ä–∞–∫ */
        #bird { 
            position: absolute; width: 48px; height: 48px; z-index: 100; left: 50px;
            background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M20,80 Q20,20 50,20 Q80,20 80,80 Q70,70 60,80 Q50,70 40,80 Q30,70 20,80' fill='white'/><circle cx='40' cy='45' r='6' fill='%23ff69b4'/><circle cx='65' cy='45' r='6' fill='%23ff69b4'/></svg>") no-repeat;
            background-size: contain; display: none;
        }
        #hat-overlay { position: absolute; top: -18px; left: 8px; font-size: 24px; pointer-events: none; }

        /* –ê—É—Ä—ã —Å–∫–∏–Ω–æ–≤ */
        .skin-default { filter: drop-shadow(0 0 10px #fff); }
        .skin-cyber { filter: drop-shadow(0 0 15px #bc13fe) hue-rotate(280deg); }
        .skin-viking { filter: drop-shadow(0 0 10px #888) sepia(0.5); }
        .skin-royal { filter: drop-shadow(0 0 20px #ffd700); }
        .skin-ninja { filter: grayscale(1) brightness(0.6) drop-shadow(0 0 5px #fff); }

        /* –¢—Ä—É–±—ã (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) */
        .pipe { position: absolute; width: 52px; background: #2c3e50; border: 3px solid #000; z-index: 50; box-sizing: border-box; }
        .pipe::after { content: ''; position: absolute; width: 60px; height: 20px; background: #34495e; border: 3px solid #000; left: -7px; }
        .pipe.top { border-radius: 0 0 5px 5px; }
        .pipe.top::after { bottom: -3px; }
        .pipe.bottom { border-radius: 5px 5px 0 0; }
        .pipe.bottom::after { top: -3px; }

        #score-display { position: absolute; top: 12%; width: 100%; text-align: center; font-size: 30px; color: #fff; z-index: 200; display: none; text-shadow: 3px 3px 0 #000; }
        #currency-bar { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); padding: 10px 15px; border-radius: 20px; border: 2px solid #9b59b6; color: #00d4ff; font-size: 10px; z-index: 1000; display: flex; align-items: center; gap: 8px; }
        
        .screen { position: absolute; inset: 0; background: rgba(5, 5, 20, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; color: #fff; }
        .leaderboard { background: #1a1a2e; border: 2px solid #9b59b6; padding: 15px; width: 270px; margin-bottom: 15px; font-size: 9px; }
        .btn { background: #9b59b6; color: #fff; border: none; padding: 18px; cursor: pointer; font-family: 'Press Start 2P', cursive; font-size: 11px; margin: 8px; box-shadow: 0 5px 0 #4a235a; width: 220px; }
        .btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #4a235a; }

        #shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
        .shop-card { background: #161625; border: 2px solid #333; padding: 15px; width: 110px; text-align: center; cursor: pointer; }
        .shop-card.owned { border-color: #2ecc71; }
        .shop-card.equipped { border-color: #00d4ff; background: #1e1e3f; }
    </style>
</head>
<body>
<div id="game-container">
    <div id="currency-bar">üíé <span id="orb-total">0</span></div>
    <div id="score-display">0</div>
    <div id="bird"><div id="hat-overlay"></div></div>
    
    <div id="menu" class="screen">
        <h2 style="font-size: 14px; color: #9b59b6;">GHOST WORLD</h2>
        <div class="leaderboard" id="scores-list">Loading ranking...</div>
        <button class="btn" onclick="initGame()">PLAY</button>
        <button class="btn" onclick="openShop()" style="background:#2980b9; box-shadow:0 5px 0 #1a5276;">SHOP</button>
    </div>

    <div id="shop-screen" class="screen" style="display:none">
        <h2 style="font-size: 12px;">SKINS</h2>
        <div id="shop-grid"></div>
        <button class="btn" onclick="closeShop()">BACK</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const BASE_DB_URL = "https://birdgame-1649d-default-rtdb.firebaseio.com/users";
    const bird = document.getElementById('bird'), hatOverlay = document.getElementById('hat-overlay');
    const orbTotalDisp = document.getElementById('orb-total'), scoreDisplay = document.getElementById('score-display');
    
    let birdY, velocity, score, isRunning = false, pipes = [], frameId;
    let orbs = parseInt(localStorage.getItem('gh_orbs')) || 0;
    let ownedSkins = JSON.parse(localStorage.getItem('gh_skins')) || ['DEFAULT'];
    let currentSkinId = localStorage.getItem('gh_current_skin') || 'DEFAULT';

    const skins = [
        { id: 'DEFAULT', name: 'GHOST', emoji: '', price: 0, class: 'skin-default' },
        { id: 'CYBER', name: 'CYBER', emoji: 'üï∂Ô∏è', price: 20, class: 'skin-cyber' },
        { id: 'VIKING', name: 'VIKING', emoji: 'ü™ì', price: 40, class: 'skin-viking' },
        { id: 'ROYAL', name: 'ROYAL', emoji: 'üëë', price: 75, class: 'skin-royal' },
        { id: 'NINJA', name: 'NINJA', emoji: 'ü•∑', price: 100, class: 'skin-ninja' }
    ];

    const userId = tg.initDataUnsafe?.user?.id || "local_user";
    const userName = tg.initDataUnsafe?.user?.first_name || "Player";

    function updateVisuals() {
        orbTotalDisp.innerText = orbs;
        const s = skins.find(x => x.id === currentSkinId);
        bird.className = s.class;
        hatOverlay.innerText = s.emoji;
    }

    function renderShop() {
        document.getElementById('shop-grid').innerHTML = skins.map(s => {
            const owned = ownedSkins.includes(s.id);
            const equipped = currentSkinId === s.id;
            return `
                <div class="shop-card ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''}" onclick="buySkin('${s.id}')">
                    <div style="font-size:24px">${s.emoji || 'üëª'}</div>
                    <div style="font-size:7px; margin-top:5px;">${s.name}</div>
                    <div style="font-size:8px; color:#00d4ff">${owned ? (equipped ? 'USE' : 'OWNED') : s.price + 'üíé'}</div>
                </div>
            `;
        }).join('');
    }

    function buySkin(id) {
        const s = skins.find(x => x.id === id);
        if (ownedSkins.includes(id)) {
            currentSkinId = id;
            tg.HapticFeedback.impactOccurred('light');
        } else if (orbs >= s.price) {
            orbs -= s.price;
            ownedSkins.push(id);
            currentSkinId = id;
            tg.HapticFeedback.notificationOccurred('success');
        } else {
            tg.HapticFeedback.notificationOccurred('error');
            return;
        }
        localStorage.setItem('gh_orbs', orbs);
        localStorage.setItem('gh_skins', JSON.stringify(ownedSkins));
        localStorage.setItem('gh_current_skin', currentSkinId);
        updateVisuals(); renderShop();
    }

    function openShop() { document.getElementById('shop-screen').style.display = 'flex'; renderShop(); }
    function closeShop() { document.getElementById('shop-screen').style.display = 'none'; }

    async function loadRank() {
        try {
            const res = await fetch(`${BASE_DB_URL}.json`);
            const data = await res.json();
            if(!data) return;
            const sorted = Object.values(data).filter(x => x && x.score !== undefined).sort((a,b) => b.score - a.score).slice(0, 5);
            document.getElementById('scores-list').innerHTML = sorted.map((r, i) => 
                `<div style="display:flex; justify-content:space-between; margin:5px 0;"><span>#${i+1} ${r.name}</span><span>${r.score}</span></div>`
            ).join('');
        } catch(e) {}
    }

    // --- –ì–ï–ô–ú–ü–õ–ï–ô (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç—Ä—É–±—ã –∏ —Ñ–∏–∑–∏–∫–∞) ---
    function initGame() {
        isRunning = true; score = 0; birdY = window.innerHeight/2.5; velocity = 0;
        pipes.forEach(p => { p.t.remove(); p.b.remove(); }); pipes = [];
        scoreDisplay.innerText = "0"; scoreDisplay.style.display = 'block';
        document.getElementById('menu').style.display = 'none';
        bird.style.display = 'block'; updateVisuals();
        requestAnimationFrame(update);
    }

    function update() {
        if (!isRunning) return;
        velocity += 0.25; // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
        birdY += velocity;
        bird.style.top = birdY + 'px';
        bird.style.transform = `rotate(${Math.min(velocity*3, 25)}deg)`;
        
        if (birdY > window.innerHeight - 80 || birdY < -20) return die();

        if (pipes.length === 0 || pipes[pipes.length-1].x < window.innerWidth - 220) {
            const gap = 175;
            const minPipeHeight = 50;
            const topHeight = Math.random() * (window.innerHeight - gap - 200) + minPipeHeight;
            const bottomHeight = window.innerHeight - topHeight - gap;

            const t = document.createElement('div'); t.className = 'pipe top'; 
            t.style.height = topHeight + 'px'; t.style.top = '0';
            const b = document.createElement('div'); b.className = 'pipe bottom'; 
            b.style.height = bottomHeight + 'px'; b.style.bottom = '0';
            
            document.getElementById('game-container').appendChild(t);
            document.getElementById('game-container').appendChild(b);
            pipes.push({x: window.innerWidth, t, b, passed: false});
        }

        pipes.forEach((p, i) => {
            p.x -= 3.2; // –°–∫–æ—Ä–æ—Å—Ç—å —Ç—Ä—É–±
            p.t.style.left = p.x + 'px';
            p.b.style.left = p.x + 'px';
            
            const br = bird.getBoundingClientRect(), tr = p.t.getBoundingClientRect(), brr = p.b.getBoundingClientRect();
            if (br.right-10 > tr.left && br.left+10 < tr.right && (br.top+10 < tr.bottom || br.bottom-10 > brr.top)) die();
            
            if (!p.passed && p.x < 50) { 
                p.passed = true; score++; orbs++; 
                scoreDisplay.innerText = score;
                orbTotalDisp.innerText = orbs;
                localStorage.setItem('gh_orbs', orbs);
                tg.HapticFeedback.impactOccurred('medium'); 
            }
            if (p.x < -60) { p.t.remove(); p.b.remove(); pipes.splice(i, 1); }
        });
        frameId = requestAnimationFrame(update);
    }

    function die() {
        isRunning = false; cancelAnimationFrame(frameId);
        tg.HapticFeedback.notificationOccurred('error');
        saveToFirebase(score);
        loadRank();
        document.getElementById('menu').style.display = 'flex';
        scoreDisplay.style.display = 'none';
        bird.style.display = 'none';
    }

    async function saveToFirebase(s) {
        if (s <= 0) return;
        const res = await fetch(`${BASE_DB_URL}/${userId}.json`);
        const current = await res.json();
        if (!current || s > current.score) {
            await fetch(`${BASE_DB_URL}/${userId}.json`, {
                method: 'PUT',
                body: JSON.stringify({ id: userId, name: userName, score: s })
            });
        }
    }

    const triggerJump = (e) => { if(isRunning) velocity = -5.2; };
    window.addEventListener('touchstart', triggerJump);
    window.addEventListener('mousedown', triggerJump);

    updateVisuals(); loadRank();
</script>
</body>
</html>
