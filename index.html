<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flappy Bird Firebase Live</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Press Start 2P', cursive; touch-action: none; -webkit-tap-highlight-color: transparent; }
        canvas { display: block; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .leaderboard { background: rgba(0,0,0,0.9); padding: 15px; border: 3px solid #f1c40f; margin-top: 15px; font-size: 10px; width: 240px; display: none; pointer-events: auto; }
        .score-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        #status-text { font-size: 14px; text-shadow: 2px 2px 0 #000; text-align: center; line-height: 1.6; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="status-text">FLAPPY BIRD<br><br>ТАПНИ ПО ЭКРАНУ</div>
    <div id="leaderboard" class="leaderboard">
        <h3 style="text-align:center; color:#f1c40f; margin-top:0; font-size:12px;">TOP 5 PLAYERS</h3>
        <div id="leader-rows"></div>
    </div>
</div>
<canvas id="game"></canvas>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // КОНФИГУРАЦИЯ С ТВОИМ КЛЮЧОМ
    const firebaseConfig = {
        apiKey: "AIzaSyBZnG_M4EG1H8RKLhJJ9GIbZpipurLTpAs",
        databaseURL: "https://birdgame-1649d-default-rtdb.firebaseio.com",
        projectId: "birdgame-1649d",
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('status-text');
    const leaderboardDiv = document.getElementById('leaderboard');
    const leaderRows = document.getElementById('leader-rows');

    let W, H, bird, pipes, score, isPlay = false, frame = 0, pipeSpeed = 3.2, gap = 165;

    const birdImg = new Image(); birdImg.src = 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-midflap.png';
    const bgImg = new Image(); bgImg.src = 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/background-day.png';
    const pipeImg = new Image(); pipeImg.src = 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/pipe-green.png';

    function resize() {
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function init() {
        bird = { y: H/2, v: 0, g: 0.25, w: 34, h: 24 };
        pipes = []; score = 0; frame = 0; pipeSpeed = 3.2; gap = 165;
        isPlay = true;
        statusText.style.display = 'none';
        leaderboardDiv.style.display = 'none';
        loop();
    }

    function loop() {
        if(!isPlay) return;
        ctx.clearRect(0,0,W,H);
        ctx.drawImage(bgImg, 0, 0, W, H);

        bird.v += bird.g;
        bird.y += bird.v;

        ctx.save();
        ctx.translate(60 + bird.w/2, bird.y + bird.h/2);
        ctx.rotate(Math.min(Math.PI/2, bird.v * 0.1));
        ctx.drawImage(birdImg, -bird.w/2, -bird.h/2, bird.w, bird.h);
        ctx.restore();

        if (frame % 90 === 0) {
            let top = Math.random() * (H - gap - 250) + 120;
            pipes.push({ x: W, top: top, passed: false });
        }

        pipes.forEach((p, i) => {
            p.x -= pipeSpeed;
            ctx.drawImage(pipeImg, p.x, p.top + gap, 52, 450); 
            ctx.save();
            ctx.translate(p.x + 26, p.top);
            ctx.rotate(Math.PI);
            ctx.drawImage(pipeImg, -26, 0, 52, 450);
            ctx.restore();

            if (60 + bird.w - 4 > p.x && 60 + 4 < p.x + 52) {
                if (bird.y + 4 < p.top || bird.y + bird.h - 4 > p.top + gap) gameOver();
            }

            if (!p.passed && p.x < 60) {
                p.passed = true; score++;
                tg.HapticFeedback.impactOccurred('medium');
                if (score % 20 === 0) { pipeSpeed += 0.4; gap = Math.max(125, gap - 8); }
            }
            if (p.x < -60) pipes.splice(i, 1);
        });

        if (bird.y > H || bird.y < -50) gameOver();

        ctx.fillStyle = "white";
        ctx.strokeStyle = "black";
        ctx.lineWidth = 4;
        ctx.font = "35px 'Press Start 2P'";
        ctx.textAlign = "center";
        ctx.strokeText(score, W/2, 100);
        ctx.fillText(score, W/2, 100);

        frame++;
        requestAnimationFrame(loop);
    }

    function gameOver() {
        isPlay = false;
        tg.HapticFeedback.notificationOccurred('error');
        statusText.innerHTML = "GAME OVER<br>SCORE: " + score + "<br><br>TAP TO RESTART";
        statusText.style.display = 'block';
        saveScore(score);
        showLeaderboard();
    }

    function saveScore(s) {
        const user = tg.initDataUnsafe.user;
        const name = user ? user.first_name : "Player";
        const id = user ? user.id : "anon_" + Math.floor(Math.random()*1000);
        
        db.ref('leaderboard/' + id).once('value', snapshot => {
            const oldData = snapshot.val();
            if (!oldData || s > oldData.score) {
                db.ref('leaderboard/' + id).set({ name: name, score: s });
            }
        });
    }

    function showLeaderboard() {
        db.ref('leaderboard').orderByChild('score').limitToLast(5).once('value', snap => {
            leaderRows.innerHTML = "";
            let players = [];
            snap.forEach(child => { players.push(child.val()); });
            players.reverse().forEach((p, i) => {
                leaderRows.innerHTML += `<div class="score-row"><span>${i+1}. ${p.name}</span><span>${p.score}</span></div>`;
            });
            leaderboardDiv.style.display = 'block';
        });
    }

    window.addEventListener('touchstart', (e) => {
        if (!isPlay) {
            init();
        } else {
            bird.v = -5.8;
            tg.HapticFeedback.impactOccurred('light');
        }
        if(e.cancelable) e.preventDefault();
    }, {passive: false});
</script>
</body>
</html>
