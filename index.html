<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flappy King</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
@font-face {
    font-family: "Pixel";
    src: url("https://fonts.gstatic.com/s/pressstart2p/v15/e3t4euO8T0x7C6T6k5qI.ttf");
}

html, body {
    margin: 0; padding: 0;
    background: #4ec0ca;
    overflow: hidden;
    font-family: "Pixel", sans-serif;
    height: 100%;
}

canvas {
    display: block;
    margin: auto;
    image-rendering: pixelated;
    touch-action: none;
}

#ui {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 10;
}

/* SCORE - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω, —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä–µ–∑–∞–ª—Å—è */
#score {
    position: absolute;
    top: 40px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ TG */
    width: 100%;
    text-align: center;
    font-size: 32px;
    color: #fff;
    text-shadow: 3px 3px 0 #000, -1px -1px 0 #000;
}

/* SCREENS */
.screen {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    background: rgba(0,0,0,.4);
    color: white;
}

.title-box {
    padding: 20px;
    border: 4px solid #000;
    background: #fb923c;
    box-shadow: 6px 6px 0 #000;
    width: 240px;
    text-align: center;
}

.title { font-size: 20px; text-shadow: 2px 2px 0 #000; }
.subtitle { margin-top: 10px; font-size: 10px; opacity: .9; }

/* RETRO BUTTON - –£–≤–µ–ª–∏—á–µ–Ω—ã –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∫–ª–∏–∫–∞ */
.pixel-btn {
    pointer-events: auto;
    margin-top: 20px;
    padding: 16px 24px;
    background: #f97316;
    color: white;
    border: 4px solid #000;
    font-family: "Pixel", sans-serif;
    font-size: 14px;
    box-shadow: 4px 4px 0 #000;
    cursor: pointer;
}

.pixel-btn:active {
    transform: translate(2px,2px);
    box-shadow: 2px 2px 0 #000;
}

.shield-btn { background: #2ecc71; }
</style>
</head>

<body>

<div id="ui">
    <div id="score">0</div>

    <div id="startScreen" class="screen">
        <div class="title-box">
            <div class="title">FLAPPY KING</div>
            <div class="subtitle">TAP TO FLY</div>
        </div>
        <button class="pixel-btn" onclick="startGame()">START</button>
    </div>

    <div id="gameOver" class="screen" style="display:none">
        <div class="title-box">
            <div class="title">GAME OVER</div>
            <div class="subtitle" id="finalScore"></div>
        </div>
        <button id="shieldBtn" class="pixel-btn shield-btn" onclick="useShield()">üõ° GET SHIELD</button>
        <button class="pixel-btn" onclick="reset()">RESTART</button>
    </div>
</div>

<canvas id="game"></canvas>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const BASE_W = 288;
const BASE_H = 512;
const GROUND_H = 112;

let scale = 1;
function resize() {
    // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –ø–æ –≤—ã—Å–æ—Ç–µ
    scale = innerHeight / BASE_H;
    canvas.width = innerWidth;
    canvas.height = innerHeight;
    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É
    ctx.setTransform(scale, 0, 0, scale, (innerWidth - BASE_W * scale) / 2, 0);
}
addEventListener("resize", resize);
resize();

/* ASSETS - –¢–≤–æ–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Å–ø—Ä–∞–π—Ç—ã */
const assets = {
    bg: new Image(),
    ground: new Image(),
    pipe: new Image(),
    bird: []
};

assets.bg.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/background-day.png";
assets.ground.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/base.png";
assets.pipe.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/pipe-green.png";
["upflap","midflap","downflap"].forEach((f,i)=>{
    assets.bird[i] = new Image();
    assets.bird[i].src = `https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/bluebird-${f}.png`;
});

/* GAME PARAMETERS */
let bird, pipes, score, shieldState;
let started = false;
let isGameOver = false;

const gravity = 0.30;
const flapPower = -5.2;
const pipeSpeed = 2.2;
const pipeGap = 110; // –ü—Ä–æ—Ö–æ–¥ —Å—Ç–∞–ª —á—É—Ç—å –±–æ–ª—å—à–µ
const pipeDistance = 220; // –¢—Ä—É–±—ã —Ç–µ–ø–µ—Ä—å —Ä–µ–∂–µ

function reset() {
    bird = { x: 60, y: 240, v: 0 };
    pipes = [];
    score = 0;
    shieldState = 0; // 0: can get, 1: ready, 2: used
    started = false;
    isGameOver = false;
    document.getElementById("score").innerText = score;
    document.getElementById("startScreen").style.display = "flex";
    document.getElementById("gameOver").style.display = "none";
    document.getElementById("shieldBtn").style.display = "block";
    document.getElementById("shieldBtn").innerText = "üõ° GET SHIELD";
}

function startGame() {
    started = true;
    document.getElementById("startScreen").style.display = "none";
}

function addPipe() {
    // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω: –ø–ª–∞–≤–Ω—ã–µ —Å–∫–∞—á–∫–∏ (—Ü–µ–Ω—Ç—Ä –≤—Å–µ–≥–¥–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 150-300px)
    const prevTop = pipes.length > 0 ? pipes[pipes.length-1].top : 200;
    const shift = (Math.random() - 0.5) * 100; // –û–≥—Ä–∞–Ω–∏—á–∏–ª–∏ –ø—Ä—ã–∂–æ–∫ –¥–æ 50px
    const top = Math.max(100, Math.min(300, prevTop + shift));
    
    pipes.push({
        x: BASE_W,
        top,
        bottom: top + pipeGap,
        passed: false
    });
}

function update() {
    if (!started || isGameOver) return;

    bird.v += gravity;
    bird.y += bird.v;

    if (pipes.length === 0 || pipes[pipes.length-1].x < BASE_W - pipeDistance)
        addPipe();

    pipes.forEach(p => {
        p.x -= pipeSpeed;

        if (!p.passed && p.x + 52 < bird.x) {
            p.passed = true;
            score++;
            document.getElementById("score").innerText = score;
            tg.HapticFeedback.impactOccurred('light');
        }

        // –•–∏—Ç–±–æ–∫—Å—ã –ø—Ç–∏—Ü—ã
        if (
            bird.x + 30 > p.x &&
            bird.x + 5 < p.x + 52 &&
            (bird.y + 5 < p.top || bird.y + 20 > p.bottom)
        ) endGame();
    });

    pipes = pipes.filter(p => p.x > -60);

    if (bird.y > BASE_H - GROUND_H - 24 || bird.y < -20)
        endGame();
}

function draw() {
    ctx.clearRect(-innerWidth, 0, innerWidth*2, BASE_H);
    ctx.drawImage(assets.bg, 0, 0);

    pipes.forEach(p => {
        ctx.save();
        ctx.translate(p.x + 26, p.top);
        ctx.scale(1,-1);
        ctx.drawImage(assets.pipe, -26, 0);
        ctx.restore();
        ctx.drawImage(assets.pipe, p.x, p.bottom);
    });

    // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–≤–æ–µ–π –ø—Ç–∏—Ü—ã
    const birdFrame = Math.floor(Date.now()/140)%3;
    ctx.drawImage(assets.bird[birdFrame], bird.x, bird.y);

    // –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –∑–µ–º–ª—è
    ctx.drawImage(assets.ground, 0, BASE_H - GROUND_H);
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

function flap() {
    if (!started) startGame();
    if (!isGameOver) {
        bird.v = flapPower;
    }
}

function endGame() {
    isGameOver = true;
    tg.HapticFeedback.notificationOccurred('error');
    document.getElementById("finalScore").innerText = "SCORE: " + score;
    document.getElementById("gameOver").style.display = "flex";
}

function useShield() {
    const btn = document.getElementById("shieldBtn");
    if (shieldState === 0) {
        tg.openLink('https://t.me/CodeGramApp');
        shieldState = 1;
        btn.innerText = "‚úÖ ACTIVATE SHIELD";
    } else if (shieldState === 1) {
        shieldState = 2;
        isGameOver = false;
        bird.y = 200;
        bird.v = 0;
        pipes = [];
        document.getElementById("gameOver").style.display = "none";
        btn.style.display = "none";
    }
}

canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    flap();
}, {passive: false});

reset();
loop();
</script>
</body>
</html>
