<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flappy Prompt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
@font-face {
    font-family: "Pixel";
    src: url("https://fonts.gstatic.com/s/pressstart2p/v15/e3t4euO8T0x7C6T6k5qI.ttf");
}

html, body {
    margin: 0;
    padding: 0;
    background: black;
    overflow: hidden;
    font-family: Pixel, monospace;
}

canvas {
    display: block;
    margin: auto;
    image-rendering: pixelated;
}

#ui {
    position: absolute;
    inset: 0;
    pointer-events: none;
}

#score {
    position: absolute;
    top: 24px;
    width: 100%;
    text-align: center;
    font-size: 28px;
    color: white;
    text-shadow: 3px 3px 0 #000;
}

/* RETRO SCREENS */
.screen {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    background: rgba(0,0,0,.35);
    color: white;
    text-align: center;
}

.pixel-btn {
    pointer-events: auto;
    margin-top: 20px;
    padding: 14px 22px;
    background: #f97316;
    color: white;
    border: 4px solid #000;
    font-size: 14px;
    text-transform: uppercase;
    box-shadow: 4px 4px 0 #000;
}

.pixel-btn:active {
    transform: translate(2px,2px);
    box-shadow: 2px 2px 0 #000;
}
</style>
</head>

<body>

<div id="ui">
    <div id="score">0</div>

    <div id="startScreen" class="screen">
        <h1>FLAPPY</h1>
        <p>Tap to fly</p>
        <button class="pixel-btn" onclick="startGame()">START</button>
    </div>

    <div id="gameOver" class="screen" style="display:none">
        <h2>GAME OVER</h2>
        <p id="finalScore"></p>
        <button class="pixel-btn" onclick="reset()">RESTART</button>
    </div>
</div>

<canvas id="game"></canvas>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const BASE_W = 288;
const BASE_H = 512;
const GROUND_H = 112;

let scale = 1;
function resize() {
    scale = Math.min(innerWidth / BASE_W, innerHeight / BASE_H);
    canvas.width = BASE_W * scale;
    canvas.height = BASE_H * scale;
    ctx.setTransform(scale,0,0,scale,0,0);
}
addEventListener("resize", resize);
resize();

/* ASSETS */
const assets = {
    bg: new Image(),
    ground: new Image(),
    pipe: new Image(),
    bird: []
};

assets.bg.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/background-day.png";
assets.ground.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/base.png";
assets.pipe.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/pipe-green.png";
["upflap","midflap","downflap"].forEach((f,i)=>{
    assets.bird[i] = new Image();
    assets.bird[i].src =
        `https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/bluebird-${f}.png`;
});

/* GAME STATE */
let bird, pipes, score;
let started = false;
let gameOver = false;

const gravity = 0.35;
const flapPower = -6.5;
const pipeSpeed = 2;
const pipeGap = 100;

function reset() {
    bird = { x: 60, y: 240, v: 0 };
    pipes = [];
    score = 0;
    started = false;
    gameOver = false;
    document.getElementById("score").innerText = score;
    document.getElementById("startScreen").style.display = "flex";
    document.getElementById("gameOver").style.display = "none";
}

function startGame() {
    started = true;
    document.getElementById("startScreen").style.display = "none";
}

function addPipe() {
    const top = Math.random() * 150 + 40;
    pipes.push({
        x: BASE_W,
        top,
        bottom: top + pipeGap,
        passed: false
    });
}

function update() {
    if (!started || gameOver) return;

    bird.v += gravity;
    bird.y += bird.v;

    if (pipes.length === 0 || pipes[pipes.length-1].x < 140)
        addPipe();

    pipes.forEach(p => {
        p.x -= pipeSpeed;

        if (!p.passed && p.x + 52 < bird.x) {
            p.passed = true;
            score++;
            document.getElementById("score").innerText = score;
        }

        if (
            bird.x + 17 > p.x &&
            bird.x < p.x + 52 &&
            (bird.y < p.top || bird.y + 12 > p.bottom)
        ) endGame();
    });

    pipes = pipes.filter(p => p.x > -60);

    if (bird.y > BASE_H - GROUND_H - 12 || bird.y < 0)
        endGame();
}

function draw() {
    ctx.drawImage(assets.bg, 0, 0);

    pipes.forEach(p => {
        ctx.save();
        ctx.translate(p.x + 26, p.top);
        ctx.scale(1,-1);
        ctx.drawImage(assets.pipe, -26, 0);
        ctx.restore();
        ctx.drawImage(assets.pipe, p.x, p.bottom);
    });

    ctx.drawImage(
        assets.bird[Math.floor(Date.now()/120)%3],
        bird.x,
        bird.y
    );

    ctx.drawImage(assets.ground, 0, BASE_H - GROUND_H);
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

function flap() {
    if (!started) startGame();
    if (!gameOver) bird.v = flapPower;
}

function endGame() {
    gameOver = true;
    document.getElementById("finalScore").innerText = "SCORE: " + score;
    document.getElementById("gameOver").style.display = "flex";
}

canvas.addEventListener("click", flap);
document.addEventListener("keydown", e=>e.code==="Space"&&flap());

reset();
loop();
</script>
</body>
</html>
