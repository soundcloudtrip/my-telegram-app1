<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    
    body, html { 
        margin: 0; padding: 0; width: 100%; height: 100%; 
        overflow: hidden; background: #4ec0ca; 
        font-family: 'Press Start 2P', cursive;
    }
    
    canvas { display: block; image-rendering: pixelated; touch-action: none; }

    #ui {
        position: absolute; inset: 0; pointer-events: none;
        display: flex; flex-direction: column; align-items: center;
    }

    #score {
        margin-top: 50px; font-size: 34px; color: white;
        text-shadow: 4px 4px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
        z-index: 5;
    }

    .screen {
        position: absolute; inset: 0; display: flex;
        align-items: center; justify-content: center;
        flex-direction: column; background: rgba(0,0,0,0.3);
        pointer-events: auto; z-index: 10;
    }

    /* –ü–ò–ö–°–ï–õ–¨–ù–´–ô –°–¢–ò–õ–¨ –ö–ù–û–ü–û–ö */
    .pixel-btn {
        background: #e86101; color: white;
        border: 4px solid #543847; padding: 15px 30px;
        font-family: 'Press Start 2P', cursive; font-size: 14px;
        box-shadow: 0 6px 0 #a04000, inset 0 -4px 0 #a04000;
        cursor: pointer; margin: 10px;
        text-transform: uppercase;
    }

    .pixel-btn:active { transform: translateY(3px); box-shadow: 0 3px 0 #a04000; }
    .shield-btn { background: #2ecc71; box-shadow: 0 6px 0 #1b8a4a; }
</style>
</head>
<body>

<div id="ui">
    <div id="score">0</div>
    
    <div id="startScreen" class="screen">
        <button class="pixel-btn" onclick="startGame()">PLAY</button>
    </div>

    <div id="gameOver" class="screen" style="display:none">
        <div style="color: white; font-size: 20px; margin-bottom: 20px; text-shadow: 2px 2px #000;">GAME OVER</div>
        <button id="shieldBtn" class="pixel-btn shield-btn" onclick="useShield()">üõ° SHIELD</button>
        <button class="pixel-btn" onclick="reset()">RETRY</button>
    </div>
</div>

<canvas id="game"></canvas>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
const BASE_W = 288;
const BASE_H = 512;
let scale = 1;

function resize() {
    scale = Math.min(window.innerWidth / BASE_W, window.innerHeight / BASE_H);
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ASSETS - –¢–≤–æ–∏ —Å–∏–Ω–∏–µ –ø—Ç–∏—Ü—ã –∏ —Ç—Ä—É–±—ã */
const assets = {
    bg: new Image(),
    ground: new Image(),
    pipe: new Image(),
    bird: []
};
assets.bg.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/background-day.png";
assets.ground.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/base.png";
assets.pipe.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/pipe-green.png";
["upflap","midflap","downflap"].forEach((f,i)=>{
    assets.bird[i] = new Image();
    assets.bird[i].src = `https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/bluebird-${f}.png`;
});

let bird, pipes, score, gameActive, shieldState;
const gravity = 0.28;
const flapPower = -5.5;
const pipeSpeed = 2.4;
const pipeGap = 120; // –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∑–æ—Ä

function reset() {
    bird = { x: 50, y: BASE_H/2, v: 0, w: 34, h: 24 };
    pipes = []; score = 0; gameActive = false; shieldState = 0;
    document.getElementById("score").innerText = score;
    document.getElementById("startScreen").style.display = "flex";
    document.getElementById("gameOver").style.display = "none";
    document.getElementById("shieldBtn").style.display = "block";
}

function startGame() {
    gameActive = true;
    document.getElementById("startScreen").style.display = "none";
}

function spawnPipe() {
    // –£–í–ï–õ–ò–ß–ï–ù–ù–ê–Ø –°–õ–û–ñ–ù–û–°–¢–¨: —Ç—Ä—É–±—ã —Ç–µ–ø–µ—Ä—å –ø–æ –≤—Å–µ–π –≤—ã—Å–æ—Ç–µ
    const minPipeY = 60;
    const maxPipeY = BASE_H - pipeGap - 120;
    const top = Math.random() * (maxPipeY - minPipeY) + minPipeY;
    pipes.push({ x: BASE_W, top: top, passed: false });
}

function update() {
    if (!gameActive) return;
    bird.v += gravity; bird.y += bird.v;

    if (pipes.length === 0 || pipes[pipes.length-1].x < BASE_W - 180) spawnPipe();

    pipes.forEach(p => {
        p.x -= pipeSpeed;
        // –ö–æ–ª–ª–∏–∑–∏—è (—Ö–∏—Ç–±–æ–∫—Å—ã)
        if (bird.x + 5 < p.x + 52 && bird.x + bird.w - 5 > p.x) {
            if (bird.y + 5 < p.top || bird.y + bird.h - 5 > p.top + pipeGap) endGame();
        }
        if (!p.passed && p.x + 52 < bird.x) {
            p.passed = true; score++;
            document.getElementById("score").innerText = score;
            tg.HapticFeedback.impactOccurred('light');
        }
    });
    pipes = pipes.filter(p => p.x > -60);
    if (bird.y + bird.h > BASE_H - 112 || bird.y < 0) endGame();
}

function draw() {
    ctx.save();
    ctx.scale(scale, scale);
    ctx.translate((canvas.width/scale - BASE_W)/2, 0); // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

    ctx.drawImage(assets.bg, 0, 0);
    pipes.forEach(p => {
        // Top pipe
        ctx.save();
        ctx.translate(p.x + 26, p.top); ctx.scale(1, -1);
        ctx.drawImage(assets.pipe, -26, 0);
        ctx.restore();
        // Bottom pipe
        ctx.drawImage(assets.pipe, p.x, p.top + pipeGap);
    });
    
    const f = Math.floor(Date.now()/140)%3;
    ctx.drawImage(assets.bird[f], bird.x, bird.y);
    ctx.drawImage(assets.ground, 0, BASE_H - 112, BASE_W, 112);
    ctx.restore();
}

function endGame() {
    gameActive = false;
    tg.HapticFeedback.notificationOccurred('error');
    document.getElementById("gameOver").style.display = "flex";
}

function useShield() {
    const btn = document.getElementById("shieldBtn");
    if (shieldState === 0) {
        tg.openLink('https://t.me/CodeGramApp');
        shieldState = 1; btn.innerText = "ACTIVATE";
    } else {
        gameActive = true; pipes = []; spawnPipe();
        bird.y = BASE_H/2; bird.v = 0;
        document.getElementById("gameOver").style.display = "none";
        btn.style.display = "none";
    }
}

function loop() { update(); draw(); requestAnimationFrame(loop); }

window.addEventListener("touchstart", (e) => {
    if (gameActive) bird.v = flapPower;
    if (e.target.tagName !== "BUTTON") e.preventDefault();
}, {passive: false});

reset(); loop();
</script>
</body>
</html>
