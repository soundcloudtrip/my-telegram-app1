<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ghosty Shop Online</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #000; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; font-family: 'Press Start 2P', cursive; touch-action: none; -webkit-tap-highlight-color: transparent; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #0a0a1a url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/background-night.png') bottom center; background-size: cover; overflow: hidden; }
        
        #bird { 
            position: absolute; width: 42px; height: 42px; z-index: 100; top: 0; left: 50px;
            background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M20,80 Q20,20 50,20 Q80,20 80,80 Q70,70 60,80 Q50,70 40,80 Q30,70 20,80' fill='white'/><circle cx='40' cy='45' r='6' fill='%23ff69b4'/><circle cx='65' cy='45' r='6' fill='%23ff69b4'/></svg>") no-repeat;
            background-size: contain; filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
            display: none;
        }
        
        #hat-overlay { position: absolute; top: -18px; left: 5px; font-size: 22px; pointer-events: none; z-index: 101; }
        .pipe { position: absolute; width: 52px; background: url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/pipe-green.png') repeat-y; background-size: 52px auto; z-index: 50; border: 2px solid #000; filter: hue-rotate(260deg) brightness(0.6) saturate(1.5); }
        .pipe.top { transform: rotate(180deg); }
        #score-display { position: absolute; top: 10%; width: 100%; text-align: center; font-size: 35px; color: #fff; z-index: 200; display: none; text-shadow: 0 0 10px #9b59b6; pointer-events: none; }
        #currency-bar { position: absolute; top: 20px; left: 20px; color: #00d4ff; font-size: 10px; z-index: 1000; }
        .screen { position: absolute; inset: 0; background: rgba(10, 10, 30, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; color: #fff; }
        .leaderboard { background: #1a1a3a; border: 2px solid #9b59b6; padding: 12px; width: 260px; margin-bottom: 15px; font-size: 9px; min-height: 100px; }
        .row { display: flex; justify-content: space-between; margin: 6px 0; border-bottom: 1px solid #333; padding-bottom: 3px; }
        .row.me { color: #f1c40f; }
        .btn { background: #9b59b6; color: #fff; border: none; padding: 16px 25px; cursor: pointer; font-family: 'Press Start 2P', cursive; font-size: 12px; margin: 8px; box-shadow: 0 5px 0 #4a235a; width: 200px; }
        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #4a235a; }
        #shop-screen { display: none; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .shop-item { background: #1a1a3a; border: 2px solid #9b59b6; padding: 10px; text-align: center; width: 100px; cursor: pointer; }
    </style>
</head>
<body>
<div id="game-container">
    <div id="currency-bar">üíé <span id="orb-total">0</span></div>
    <div id="score-display">0</div>
    <div id="bird"><div id="hat-overlay"></div></div>
    
    <div id="menu" class="screen">
        <h2 style="font-size: 14px; color: #9b59b6;">GHOST TOP</h2>
        <div class="leaderboard" id="scores-list">Loading...</div>
        <button class="btn" id="start-btn">PLAY</button>
        <button class="btn" id="open-shop" style="background:#2980b9; box-shadow:0 5px 0 #1a5276;">SHOP</button>
    </div>

    <div id="shop-screen" class="screen">
        <h2 style="font-size: 16px;">GHOST SHOP</h2>
        <div class="shop-grid">
            <div class="shop-item" onclick="selectHat('', 0)">üëª<br><span style="font-size:8px">FREE</span></div>
            <div class="shop-item" onclick="selectHat('üëë', 15)">üëë<br><span style="font-size:8px">15 ORBS</span></div>
            <div class="shop-item" onclick="selectHat('üßô', 30)">üßô<br><span style="font-size:8px">30 ORBS</span></div>
            <div class="shop-item" onclick="selectHat('üè¥‚Äç‚ò†Ô∏è', 50)">üè¥‚Äç‚ò†Ô∏è<br><span style="font-size:8px">50 ORBS</span></div>
        </div>
        <button class="btn" onclick="closeShop()">BACK</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const BASE_DB_URL = "https://birdgame-1649d-default-rtdb.firebaseio.com/users";
    const bird = document.getElementById('bird'), hatOverlay = document.getElementById('hat-overlay');
    const orbTotalDisp = document.getElementById('orb-total'), scoreDisplay = document.getElementById('score-display');
    const menu = document.getElementById('menu'), shopScreen = document.getElementById('shop-screen');
    
    let birdY, velocity, score, isRunning = false, pipes = [], frameId;
    let orbs = parseInt(localStorage.getItem('ghost_orbs')) || 0;
    let ownedHats = JSON.parse(localStorage.getItem('ghost_hats')) || [''];
    let currentHat = localStorage.getItem('ghost_current_hat') || '';
    
    const userId = tg.initDataUnsafe?.user?.id || "local_user";
    const firstName = tg.initDataUnsafe?.user?.first_name || "Ghost";

    orbTotalDisp.innerText = orbs;
    hatOverlay.innerText = currentHat;

    function selectHat(emoji, price) {
        if (ownedHats.includes(emoji)) {
            currentHat = emoji;
            localStorage.setItem('ghost_current_hat', emoji);
            hatOverlay.innerText = emoji;
            closeShop();
        } else if (orbs >= price) {
            orbs -= price;
            ownedHats.push(emoji);
            currentHat = emoji;
            localStorage.setItem('ghost_orbs', orbs);
            localStorage.setItem('ghost_hats', JSON.stringify(ownedHats));
            localStorage.setItem('ghost_current_hat', emoji);
            orbTotalDisp.innerText = orbs;
            hatOverlay.innerText = emoji;
            closeShop();
        } else {
            tg.showPopup({ message: "Not enough ORBS!" });
        }
    }

    function openShop() { shopScreen.style.display = 'flex'; }
    function closeShop() { shopScreen.style.display = 'none'; }
    document.getElementById('open-shop').onclick = openShop;

    async function loadScores() {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            const res = await fetch(`${BASE_DB_URL}.json`, { signal: controller.signal });
            const data = await res.json();
            clearTimeout(timeoutId);
            
            if (!data) {
                document.getElementById('scores-list').innerHTML = "No records yet";
                return;
            }
            const sorted = Object.values(data).filter(i => i && i.score !== undefined).sort((a,b) => b.score - a.score).slice(0, 5);
            document.getElementById('scores-list').innerHTML = sorted.map((r, i) => 
                `<div class="row ${r.id == userId ? 'me' : ''}"><span>#${i+1} ${r.name}</span><span>${r.score}</span></div>`
            ).join('');
        } catch(e) { 
            document.getElementById('scores-list').innerHTML = "Scoreboard offline";
        }
    }

    async function saveScore(s) {
        if (s <= 0) return;
        try {
            const res = await fetch(`${BASE_DB_URL}/${userId}.json`);
            const current = await res.json();
            if (!current || s > current.score) {
                await fetch(`${BASE_DB_URL}/${userId}.json`, {
                    method: 'PUT',
                    body: JSON.stringify({ id: userId, name: firstName, score: s })
                });
            }
        } catch(e) {}
    }

    function initGame() {
        if (isRunning) return;
        isRunning = true; score = 0; birdY = window.innerHeight/3; velocity = 0;
        pipes.forEach(p => { p.t.remove(); p.b.remove(); }); pipes = [];
        scoreDisplay.innerText = "0"; scoreDisplay.style.display = 'block';
        menu.style.display = 'none'; bird.style.display = 'block';
        requestAnimationFrame(update);
    }

    function update() {
        if (!isRunning) return;
        velocity += 0.22; birdY += velocity;
        bird.style.transform = `translateY(${birdY}px) rotate(${Math.min(velocity*4, 25)}deg)`;
        
        if (birdY > window.innerHeight - 100 || birdY < -50) return die();

        if (pipes.length === 0 || pipes[pipes.length-1].x < window.innerWidth - 240) {
            const gap = 180, topH = Math.random() * (window.innerHeight - 450) + 50;
            const t = document.createElement('div'); t.className = 'pipe top'; t.style.height = topH + 'px'; t.style.left = window.innerWidth + 'px';
            const b = document.createElement('div'); b.className = 'pipe bottom'; b.style.height = (window.innerHeight - topH - gap - 100) + 'px'; b.style.bottom = '100px'; b.style.left = window.innerWidth + 'px';
            document.getElementById('game-container').appendChild(t);
            document.getElementById('game-container').appendChild(b);
            pipes.push({x: window.innerWidth, t, b, p: false});
        }

        pipes.forEach((p, i) => {
            p.x -= 3; p.t.style.left = p.x + 'px'; p.b.style.left = p.x + 'px';
            const br = bird.getBoundingClientRect(), tr = p.t.getBoundingClientRect(), brr = p.b.getBoundingClientRect();
            if (br.right-12 > tr.left && br.left+12 < tr.right && (br.top+8 < tr.bottom || br.bottom-8 > brr.top)) die();
            if (!p.p && p.x < 50) { 
                p.p = true; score++; orbs++; 
                scoreDisplay.innerText = score;
                orbTotalDisp.innerText = orbs;
                localStorage.setItem('ghost_orbs', orbs);
                tg.HapticFeedback.impactOccurred('medium'); 
            }
            if (p.x < -60) { p.t.remove(); p.b.remove(); pipes.splice(i, 1); }
        });
        frameId = requestAnimationFrame(update);
    }

    function die() {
        isRunning = false; cancelAnimationFrame(frameId);
        tg.HapticFeedback.notificationOccurred('error');
        saveScore(score);
        loadScores();
        menu.style.display = 'flex';
        scoreDisplay.style.display = 'none';
        bird.style.display = 'none';
    }

    document.getElementById('start-btn').onclick = initGame;
    window.addEventListener('touchstart', (e) => { if(isRunning) velocity = -4.8; });
    window.addEventListener('mousedown', (e) => { if(isRunning) velocity = -4.8; });

    loadScores();
</script>
</body>
</html>
