<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flappy Prompt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body {
    margin: 0;
    background: #000;
}
canvas {
    display: block;
    margin: auto;
}
#score {
    position: absolute;
    top: 20px;
    width: 100%;
    text-align: center;
    font-size: 36px;
    font-weight: bold;
    color: white;
    text-shadow: 3px 3px 0 #000;
}
#overlay {
    position: absolute;
    inset: 0;
    display: none;
    background: rgba(0,0,0,.6);
    color: white;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
}
</style>
</head>
<body>

<div id="score">0</div>

<div id="overlay">
    <h2>Game Over</h2>
    <p id="finalScore"></p>
    <h3>üèÜ Top 5</h3>
    <ol id="leaders"></ol>
    <button onclick="reset()">Play again</button>
</div>

<canvas id="game" width="288" height="512"></canvas>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const W = 288;
const H = 512;
const GROUND_H = 112;

const user = tg.initDataUnsafe?.user;
const username = user?.username || "Anonymous";

const assets = {
    bg: new Image(),
    ground: new Image(),
    pipe: new Image(),
    bird: []
};

// üîπ pixel-recreated flappy assets (public domain style)
assets.bg.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/background-day.png";
assets.ground.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/base.png";
assets.pipe.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/pipe-green.png";
assets.bird[0] = new Image();
assets.bird[1] = new Image();
assets.bird[2] = new Image();
assets.bird[0].src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/bluebird-upflap.png";
assets.bird[1].src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/bluebird-midflap.png";
assets.bird[2].src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/bluebird-downflap.png";

let bird, pipes, score, frame, started, gameOver;

function reset() {
    bird = { x: 60, y: 240, v: 0 };
    pipes = [];
    score = 0;
    frame = 0;
    started = false;
    gameOver = false;
    document.getElementById("score").innerText = score;
    document.getElementById("overlay").style.display = "none";
}

function addPipe() {
    const gap = 100;
    const top = Math.random() * 150 + 50;
    pipes.push({
        x: W,
        top,
        bottom: top + gap,
        passed: false
    });
}

function update() {
    if (!started || gameOver) return;

    bird.v += 0.5;
    bird.y += bird.v;

    if (frame % 90 === 0) addPipe();

    pipes.forEach(p => {
        p.x -= 2;

        if (!p.passed && p.x + 52 < bird.x) {
            p.passed = true;
            score++;
            document.getElementById("score").innerText = score;
        }

        if (
            bird.x + 17 > p.x &&
            bird.x < p.x + 52 &&
            (bird.y < p.top || bird.y + 12 > p.bottom)
        ) endGame();
    });

    if (bird.y > H - GROUND_H - 12 || bird.y < 0) endGame();
}

function draw() {
    ctx.drawImage(assets.bg, 0, 0);

    pipes.forEach(p => {
        ctx.save();
        ctx.translate(p.x + 26, p.top);
        ctx.scale(1, -1);
        ctx.drawImage(assets.pipe, -26, 0);
        ctx.restore();
        ctx.drawImage(assets.pipe, p.x, p.bottom);
    });

    ctx.drawImage(
        assets.bird[Math.floor(frame / 10) % 3],
        bird.x,
        bird.y
    );

    ctx.drawImage(assets.ground, 0, H - GROUND_H);
}

function loop() {
    frame++;
    update();
    draw();
    requestAnimationFrame(loop);
}

function flap() {
    if (!started) started = true;
    if (!gameOver) bird.v = -7;
}

function endGame() {
    gameOver = true;
    saveScore();
    showLeaders();
    document.getElementById("finalScore").innerText = "Score: " + score;
    document.getElementById("overlay").style.display = "flex";
}

// üîπ Telegram CloudStorage leaderboard
function saveScore() {
    tg.CloudStorage.getItem("scores", (e, data) => {
        let scores = data ? JSON.parse(data) : [];
        scores.push({ name: username, score });
        scores.sort((a,b)=>b.score-a.score);
        scores = scores.slice(0,5);
        tg.CloudStorage.setItem("scores", JSON.stringify(scores));
    });
}

function showLeaders() {
    const list = document.getElementById("leaders");
    list.innerHTML = "";
    tg.CloudStorage.getItem("scores", (e, data) => {
        if (!data) return;
        JSON.parse(data).forEach(s => {
            const li = document.createElement("li");
            li.textContent = `${s.name}: ${s.score}`;
            list.appendChild(li);
        });
    });
}

canvas.addEventListener("click", flap);
document.addEventListener("keydown", e => e.code === "Space" && flap());

reset();
loop();
</script>
</body>
</html>
