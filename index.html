<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ghosty Legend: Dark Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #020205; overflow: hidden; touch-action: none; font-family: 'Press Start 2P', cursive; }
        #gameCanvas { display: block; width: 100vw; height: 100vh; }
        
        .ui-layer { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .screen { pointer-events: auto; background: rgba(0,0,0,0.8); padding: 40px; border: 2px solid #4b0082; text-align: center; border-radius: 15px; }
        
        h1 { color: #9b59b6; font-size: 18px; text-shadow: 0 0 10px #4b0082; margin-bottom: 30px; }
        .btn { 
            background: #4b0082; color: white; border: none; padding: 20px 40px; 
            font-family: inherit; font-size: 12px; cursor: pointer;
            border-bottom: 5px solid #2a0044; transition: 0.1s;
        }
        .btn:active { transform: translateY(3px); border-bottom: 2px solid #2a0044; }
        #score-val { position: absolute; top: 40px; font-size: 30px; color: white; text-shadow: 0 0 15px #9b59b6; display: none; }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div class="ui-layer">
    <div id="score-val">0</div>
    <div id="menu" class="screen">
        <h1>NEON CRYPT</h1>
        <button class="btn" onclick="initGame()">START GAME</button>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreDisp = document.getElementById('score-val');

// Размеры экрана
let W, H;
function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Игровые переменные
let bird, pipes, particles, score, isPlay = false, frame = 0;

// Класс призрака
class Ghost {
    constructor() {
        this.x = 60;
        this.y = H / 2;
        this.w = 50;
        this.h = 55;
        this.v = 0;
        this.g = 0.25;
        this.angle = 0;
    }
    update() {
        this.v += this.g;
        this.y += this.v;
        this.angle = Math.min(Math.PI/6, Math.max(-Math.PI/6, this.v * 0.05));
        
        // Частицы хвоста
        if (frame % 2 === 0) {
            particles.push(new Particle(this.x + 10, this.y + 25));
        }
    }
    draw() {
        ctx.save();
        ctx.translate(this.x + 25, this.y + 25);
        ctx.rotate(this.angle);
        
        // Рисуем тело призрака (Эффект свечения)
        ctx.shadowBlur = 15;
        ctx.shadowColor = "rgba(255,255,255,0.5)";
        ctx.fillStyle = "rgba(255,255,255,0.9)";
        
        // Тело
        ctx.beginPath();
        ctx.moveTo(-20, 20);
        ctx.quadraticCurveTo(-20, -25, 0, -25);
        ctx.quadraticCurveTo(20, -25, 20, 20);
        ctx.lineTo(15, 15); ctx.lineTo(10, 20); ctx.lineTo(0, 15);
        ctx.lineTo(-10, 20); ctx.lineTo(-15, 15);
        ctx.closePath();
        ctx.fill();

        // Глаза
        ctx.fillStyle = "#000";
        ctx.beginPath();
        ctx.arc(-8, -2, 3, 0, Math.PI*2);
        ctx.arc(8, -2, 3, 0, Math.PI*2);
        ctx.fill();
        
        ctx.restore();
    }
}

// Колонны (Готика)
class Pipe {
    constructor() {
        this.gap = 180;
        this.w = 70;
        this.x = W;
        this.topH = Math.random() * (H - this.gap - 200) + 100;
        this.passed = false;
    }
    update() {
        this.x -= 3.5;
    }
    draw() {
        ctx.shadowBlur = 10;
        ctx.shadowColor = "#4b0082";
        
        // Градиент колонн
        let grad = ctx.createLinearGradient(this.x, 0, this.x + this.w, 0);
        grad.addColorStop(0, "#1a1a1a");
        grad.addColorStop(0.5, "#333");
        grad.addColorStop(1, "#1a1a1a");
        ctx.fillStyle = grad;

        // Верхняя
        ctx.fillRect(this.x, 0, this.w, this.topH);
        ctx.fillStyle = "#4b0082";
        ctx.fillRect(this.x - 5, this.topH - 20, this.w + 10, 20);

        // Нижняя
        ctx.fillStyle = grad;
        ctx.fillRect(this.x, this.topH + this.gap, this.w, H - this.topH - this.gap);
        ctx.fillStyle = "#4b0082";
        ctx.fillRect(this.x - 5, this.topH + this.gap, this.w + 10, 20);
    }
}

// Частицы эктоплазмы
class Particle {
    constructor(x, y) {
        this.x = x; this.y = y;
        this.s = Math.random() * 5;
        this.vX = -Math.random() * 2;
        this.vY = (Math.random() - 0.5) * 1;
        this.a = 1;
    }
    update() {
        this.x += this.vX; this.y += this.vY;
        this.a -= 0.02;
    }
    draw() {
        ctx.fillStyle = `rgba(255, 255, 255, ${this.a})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.s, 0, Math.PI*2);
        ctx.fill();
    }
}

function initGame() {
    bird = new Ghost();
    pipes = [];
    particles = [];
    score = 0;
    isPlay = true;
    document.getElementById('menu').style.display = 'none';
    scoreDisp.style.display = 'block';
    loop();
}

function loop() {
    if (!isPlay) return;
    ctx.clearRect(0, 0, W, H);
    frame++;

    // Фон (Замок на горизонте)
    ctx.fillStyle = "#0a0a1a";
    ctx.fillRect(0, 0, W, H);
    
    // Рисуем горы/замки (упрощенно силуэтом)
    ctx.fillStyle = "#050508";
    ctx.beginPath();
    ctx.moveTo(0, H);
    for(let i=0; i<W; i+=50) {
        ctx.lineTo(i, H - 150 - Math.sin(i*0.01)*50);
    }
    ctx.lineTo(W, H); ctx.fill();

    bird.update();
    bird.draw();

    if (frame % 90 === 0) pipes.push(new Pipe());

    pipes.forEach((p, i) => {
        p.update();
        p.draw();

        // Коллизия
        if (bird.x + 40 > p.x && bird.x + 10 < p.x + p.w) {
            if (bird.y + 10 < p.topH || bird.y + 40 > p.topH + p.gap) {
                gameOver();
            }
        }

        if (!p.passed && p.x < bird.x) {
            p.passed = true;
            score++;
            scoreDisp.innerText = score;
            tg.HapticFeedback.impactOccurred('light');
        }

        if (p.x < -100) pipes.splice(i, 1);
    });

    particles.forEach((p, i) => {
        p.update();
        p.draw();
        if (p.a <= 0) particles.splice(i, 1);
    });

    if (bird.y > H || bird.y < -50) gameOver();

    requestAnimationFrame(loop);
}

function gameOver() {
    isPlay = false;
    tg.HapticFeedback.notificationOccurred('error');
    document.getElementById('menu').style.display = 'block';
    document.getElementById('menu').querySelector('h1').innerText = "REST IN PEACE: " + score;
}

const jump = () => { if(isPlay) bird.v = -6; };
window.addEventListener('touchstart', (e) => { jump(); e.preventDefault(); }, {passive: false});
window.addEventListener('mousedown', jump);

</script>
</body>
</html>
