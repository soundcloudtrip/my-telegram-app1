<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CodeGram Bird Stable</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #70c5ce; overflow: hidden; font-family: 'Press Start 2P', cursive; touch-action: none; -webkit-user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        #ui-layer { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1000; pointer-events: none; }
        .menu-box { 
            background: rgba(0, 0, 0, 0.95); padding: 20px; border: 4px solid #f1c40f; 
            text-align: center; color: white; width: 280px; border-radius: 15px;
            pointer-events: auto; /* –í–∞–∂–Ω–æ: —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏ —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å */
        }
        
        button {
            display: block; width: 100%; background: #e67e22; border: none; 
            border-bottom: 4px solid #d35400; color: white; 
            font-family: 'Press Start 2P', cursive; padding: 15px 5px;
            font-size: 10px; cursor: pointer; margin: 10px 0; border-radius: 8px;
            -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: translateY(2px); border-bottom-width: 2px; }
        
        .btn-channel { background: #3498db; border-bottom-color: #2980b9; }
        .btn-revive { background: #2ecc71; border-bottom-color: #27ae60; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        #game-score { 
            position: absolute; top: 50px; width: 100%; text-align: center; 
            color: white; font-size: 40px; text-shadow: 3px 3px 0 #000; z-index: 10; pointer-events: none;
        }
        .leaderboard { margin-top: 15px; font-size: 8px; text-align: left; max-height: 120px; overflow: hidden; }
        .score-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 4px 0; }
        #shield-ready { font-size: 10px; color: #2ecc71; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

<div id="game-score">0</div>
<div id="ui-layer">
    <div id="main-menu" class="menu-box">
        <div style="color:#f1c40f; font-size:18px; margin-bottom:20px;">CODEGRAM</div>
        <button id="btn-start">–ò–ì–†–ê–¢–¨</button>
        <div id="leaderboard-main" class="leaderboard">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤...</div>
    </div>

    <div id="death-menu" class="menu-box" style="display: none;">
        <div id="death-title" style="color:#e74c3c; font-size:16px; margin-bottom:10px;">GAME OVER</div>
        <div id="final-score" style="margin-bottom:15px; font-size:12px;"></div>
        
        <button id="btn-join" class="btn-channel">–ü–û–î–ü–ò–°–ê–¢–¨–°–Ø –ù–ê –ö–ê–ù–ê–õ<br>–ó–ê –ü–û–õ–£–ß–ï–ù–ò–ï –©–ò–¢–ê üõ°Ô∏è</button>
        <div id="shield-ready">‚ú® –©–ò–¢ –ì–û–¢–û–í ‚ú®</div>
        <button id="btn-revive" class="btn-revive" style="display: none;">–ü–†–û–î–û–õ–ñ–ò–¢–¨ (–©–ò–¢)</button>
        
        <button id="btn-restart">–ó–ê–ù–û–í–û</button>
        <div id="leaderboard-death" class="leaderboard"></div>
    </div>
</div>

<canvas id="game"></canvas>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const CHANNEL_URL = "https://t.me/CodeGramApp"; 
    const firebaseConfig = {
        apiKey: "AIzaSyBZnG_M4EG1H8RKLhJJ9GIbZpipurLTpAs",
        databaseURL: "https://birdgame-1649d-default-rtdb.firebaseio.com",
        projectId: "birdgame-1649d",
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) { console.error("Firebase init error"); }
    const db = firebase.database();

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('game-score');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const uiLayer = document.getElementById('ui-layer');
    const mainMenu = document.getElementById('main-menu');
    const deathMenu = document.getElementById('death-menu');
    const btnStart = document.getElementById('btn-start');
    const btnRestart = document.getElementById('btn-restart');
    const btnJoin = document.getElementById('btn-join');
    const btnRevive = document.getElementById('btn-revive');
    const shieldReadyText = document.getElementById('shield-ready');

    let W, H, bird, pipes, score, isPlay = false, lastTime = 0;
    let speed = 3.3, gap = 175, shieldAnim = 0;

    const birdImg = new Image(); birdImg.src = 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-midflap.png';
    const bgImg = new Image(); bgImg.src = 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/background-day.png';
    const pipeImg = new Image(); pipeImg.src = 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/pipe-green.png';

    function resize() {
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // –ö–ù–û–ü–ö–ò: –ü—Ä—è–º—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    btnStart.onclick = (e) => { e.stopPropagation(); initGame(); };
    btnRestart.onclick = (e) => { e.stopPropagation(); initGame(); };
    
    btnJoin.onclick = (e) => {
        e.stopPropagation();
        tg.openTelegramLink(CHANNEL_URL);
        btnJoin.style.display = 'none';
        shieldReadyText.style.display = 'block';
        btnRevive.style.display = 'block';
        tg.HapticFeedback.notificationOccurred('success');
    };

    btnRevive.onclick = (e) => {
        e.stopPropagation();
        revive();
    };

    function initGame() {
        score = 0;
        speed = 3.3;
        gap = 175;
        pipes = [];
        bird = { y: H/2, v: 0, g: 0.22, w: 34, h: 24, shield: false };
        start();
    }

    function start() {
        mainMenu.style.display = 'none';
        deathMenu.style.display = 'none';
        scoreEl.innerText = score;
        isPlay = true;
        lastTime = performance.now();
        requestAnimationFrame(loop);
    }

    function revive() {
        btnRevive.style.display = 'none';
        shieldReadyText.style.display = 'none';
        deathMenu.style.display = 'none';
        bird.shield = true;
        bird.v = -4; 
        isPlay = true;
        lastTime = performance.now();
        requestAnimationFrame(loop);
    }

    function loop(now) {
        if(!isPlay) return;
        const dt = Math.min((now - lastTime) / 16, 2);
        lastTime = now;

        bird.v += bird.g * dt;
        bird.y += bird.v * dt;

        if (pipes.length === 0 || pipes[pipes.length-1].x < W - 220) {
            let prevY = pipes.length > 0 ? pipes[pipes.length-1].top : H/2;
            let topH = Math.max(80, Math.min(H - gap - 120, prevY + (Math.random()*300 - 150)));
            pipes.push({ x: W, top: topH, passed: false });
        }

        ctx.clearRect(0, 0, W, H);
        ctx.drawImage(bgImg, 0, 0, W, H);

        for(let i = pipes.length - 1; i >= 0; i--) {
            let p = pipes[i];
            p.x -= speed * dt;
            ctx.drawImage(pipeImg, p.x, p.top + gap, 52, 1000);
            ctx.save();
            ctx.translate(p.x + 26, p.top); ctx.rotate(Math.PI);
            ctx.drawImage(pipeImg, -26, 0, 52, 1000);
            ctx.restore();

            if (65 + bird.w - 5 > p.x && 65 + 5 < p.x + 52) {
                if (bird.y + 5 < p.top || bird.y + bird.h - 5 > p.top + gap) {
                    if (bird.shield) {
                        bird.shield = false;
                        pipes.splice(i, 1);
                        tg.HapticFeedback.notificationOccurred('warning');
                        continue;
                    }
                    gameOver();
                }
            }
            if (!p.passed && p.x < 65) { 
                p.passed = true; score++; scoreEl.innerText = score;
                if(score > 30) { speed += 0.03; gap = Math.max(135, gap - 0.4); }
            }
            if (p.x < -60) pipes.splice(i, 1);
        }

        if (bird.y > H || bird.y < -50) gameOver();

        ctx.save();
        ctx.translate(65 + bird.w/2, bird.y + bird.h/2);
        if (bird.shield) {
            shieldAnim += 0.1;
            ctx.beginPath();
            ctx.arc(0, 0, 28 + Math.sin(shieldAnim)*3, 0, Math.PI*2);
            ctx.strokeStyle = "#2ecc71"; ctx.lineWidth = 3; ctx.stroke();
        }
        ctx.drawImage(birdImg, -bird.w/2, -bird.h/2, bird.w, bird.h);
        ctx.restore();
        requestAnimationFrame(loop);
    }

    function gameOver() {
        isPlay = false;
        tg.HapticFeedback.notificationOccurred('error');
        document.getElementById('final-score').innerText = "–°–ß–Å–¢: " + score;
        deathMenu.style.display = 'block';
        btnJoin.style.display = 'block';
        saveScore(score);
        updateLeaderboard('leaderboard-death');
    }

    function saveScore(s) {
        const u = tg.initDataUnsafe.user;
        if(u && s > 0) {
            db.ref('leaderboard/' + u.id).once('value').then(sn => {
                if(!sn.val() || s > sn.val().score) {
                    db.ref('leaderboard/' + u.id).set({ name: u.first_name, score: s });
                }
            }).catch(e => console.log("DB save error"));
        }
    }

    function updateLeaderboard(id) {
        const el = document.getElementById(id);
        db.ref('leaderboard').orderByChild('score').limitToLast(5).once('value').then(sn => {
            let l = []; sn.forEach(c => { l.push(c.val()); });
            l.sort((a, b) => b.score - a.score);
            let h = '<div style="color:#f1c40f; margin-bottom:5px;">TOP 5:</div>';
            l.forEach((p, i) => h += `<div class="score-row"><span>${i+1}. ${p.name}</span><span>${p.score}</span></div>`);
            el.innerHTML = l.length > 0 ? h : "–ë—É–¥—å –ø–µ—Ä–≤—ã–º!";
        }).catch(e => { el.innerHTML = "–†–µ–∫–æ—Ä–¥—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"; });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–ø–∞ –ø–æ —ç–∫—Ä–∞–Ω—É (–ø—Ä—ã–∂–æ–∫)
    window.addEventListener('touchstart', (e) => {
        if(isPlay) {
            bird.v = -5.2;
            tg.HapticFeedback.impactOccurred('light');
        }
    }, { passive: false });

    // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
    updateLeaderboard('leaderboard-main');
</script>
</body>
</html>
