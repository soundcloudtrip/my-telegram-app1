<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy King: Fullscreen Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #4ec0ca;
            font-family: 'Press Start 2P', cursive;
        }

        canvas {
            display: block; width: 100vw; height: 100vh;
            image-rendering: pixelated; touch-action: none;
        }

        #ui {
            position: absolute; inset: 0; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* SCORE */
        #score {
            position: absolute; top: 10%; width: 100%;
            text-align: center; font-size: 32px; color: #fff;
            text-shadow: 3px 3px 0 #000, -3px -3px 0 #000, 3px -3px 0 #000, -3px 3px 0 #000;
            z-index: 5;
        }

        .screen {
            position: absolute; inset: 0; display: flex;
            align-items: center; justify-content: center;
            flex-direction: column; background: rgba(0,0,0,0.4);
            z-index: 10; pointer-events: auto;
        }

        .pixel-box {
            background: #ded895; border: 4px solid #543847;
            padding: 20px; width: 260px; text-align: center;
            border-radius: 12px; box-shadow: 0 6px 0 rgba(0,0,0,0.2);
        }

        .title { font-size: 18px; color: #fff; text-shadow: 2px 2px 0 #543847; margin-bottom: 15px; }

        /* –ö–ù–û–ü–ö–ò */
        .pixel-btn {
            display: block; width: 100%; padding: 15px 0; margin: 10px 0;
            border: 3px solid #543847; background: #e86101; color: #fff;
            font-family: 'Press Start 2P', cursive; font-size: 10px;
            cursor: pointer; box-shadow: 0 4px 0 #a04000;
        }

        .pixel-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #a04000; }
        .shield-btn { background: #2ecc71; box-shadow: 0 4px 0 #1b8a4a; }
    </style>
</head>
<body>

<div id="ui">
    <div id="score">0</div>

    <div id="startScreen" class="screen">
        <div class="pixel-box">
            <div class="title">FLAPPY KING</div>
            <button class="pixel-btn" onclick="startGame()">START</button>
        </div>
    </div>

    <div id="gameOver" class="screen" style="display:none">
        <div class="pixel-box">
            <div class="title">GAME OVER</div>
            <div style="font-size: 10px; color: #543847; margin-bottom: 10px;">SCORE: <span id="finalScoreText">0</span></div>
            <button id="shieldBtn" class="pixel-btn shield-btn" onclick="handleShield()">üõ° –ü–û–õ–£–ß–ò–¢–¨ –©–ò–¢</button>
            <button class="pixel-btn" onclick="reset()">–ó–ê–ù–û–í–û</button>
        </div>
    </div>
</div>

<canvas id="game"></canvas>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// –ë–∞–∑–æ–≤–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏–∫–∏ (–æ—Ä–∏–≥–∏–Ω–∞–ª Flappy Bird)
const BASE_W = 288;
const BASE_H = 512;

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ASSETS */
const assets = {
    bg: new Image(),
    ground: new Image(),
    pipe: new Image(),
    bird: new Image()
};

assets.bg.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/background-day.png";
assets.ground.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/base.png";
assets.pipe.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/pipe-green.png";
assets.bird.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/yellowbird-midflap.png";

let bird, pipes, score, gameActive, shieldUsed;
const gravity = 0.25;
const flapPower = -5;
const pipeSpeed = 2.5;
const pipeGap = 150;

function reset() {
    bird = { x: 50, y: canvas.height / 2, v: 0, w: 34, h: 24 };
    pipes = [];
    score = 0;
    gameActive = false;
    shieldUsed = false;
    document.getElementById("score").innerText = score;
    document.getElementById("startScreen").style.display = "flex";
    document.getElementById("gameOver").style.display = "none";
    document.getElementById("shieldBtn").style.display = "block";
    document.getElementById("shieldBtn").innerText = "üõ° –ü–û–õ–£–ß–ò–¢–¨ –©–ò–¢";
}

function startGame() {
    gameActive = true;
    document.getElementById("startScreen").style.display = "none";
}

function spawnPipe() {
    const minH = 50;
    const maxH = canvas.height - pipeGap - 120;
    const top = Math.random() * (maxH - minH) + minH;
    pipes.push({ x: canvas.width, top, passed: false });
}

function update() {
    if (!gameActive) return;

    bird.v += gravity;
    bird.y += bird.v;

    if (pipes.length === 0 || pipes[pipes.length - 1].x < canvas.width - 200) spawnPipe();

    pipes.forEach((p, i) => {
        p.x -= pipeSpeed;

        // Collision
        if (bird.x + 5 < p.x + 52 && bird.x + bird.w - 5 > p.x) {
            if (bird.y + 5 < p.top || bird.y + bird.h - 5 > p.top + pipeGap) endGame();
        }

        if (!p.passed && p.x + 52 < bird.x) {
            p.passed = true;
            score++;
            document.getElementById("score").innerText = score;
            tg.HapticFeedback.impactOccurred('light');
        }
    });

    pipes = pipes.filter(p => p.x > -60);
    if (bird.y > canvas.height - 100 || bird.y < 0) endGame();
}

function draw() {
    ctx.imageSmoothingEnabled = false;
    
    // BG (–†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω)
    ctx.drawImage(assets.bg, 0, 0, canvas.width, canvas.height);

    // Pipes
    pipes.forEach(p => {
        // Top
        ctx.save();
        ctx.translate(p.x + 26, p.top);
        ctx.scale(1, -1);
        ctx.drawImage(assets.pipe, -26, 0, 52, p.top);
        ctx.restore();
        // Bottom
        ctx.drawImage(assets.pipe, p.x, p.top + pipeGap, 52, canvas.height);
    });

    // Bird
    ctx.save();
    ctx.translate(bird.x + bird.w/2, bird.y + bird.h/2);
    ctx.rotate(Math.min(Math.PI/2, Math.max(-Math.PI/4, bird.v * 0.1)));
    ctx.drawImage(assets.bird, -bird.w/2, -bird.h/2, bird.w, bird.h);
    ctx.restore();

    // Ground
    ctx.drawImage(assets.ground, 0, canvas.height - 100, canvas.width, 100);
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

function flap() {
    if (gameActive) {
        bird.v = flapPower;
    }
}

function endGame() {
    gameActive = false;
    tg.HapticFeedback.notificationOccurred('error');
    document.getElementById("finalScoreText").innerText = score;
    document.getElementById("gameOver").style.display = "flex";
}

function handleShield() {
    const btn = document.getElementById("shieldBtn");
    if (btn.innerText.includes("–ü–û–õ–£–ß–ò–¢–¨")) {
        tg.openLink('https://t.me/CodeGramApp');
        btn.innerText = "‚úÖ –ü–†–û–î–û–õ–ñ–ò–¢–¨";
        btn.style.background = "#3498db";
    } else {
        gameActive = true;
        bird.y = canvas.height / 2;
        bird.v = 0;
        pipes = [];
        document.getElementById("gameOver").style.display = "none";
        btn.style.display = "none"; // –û–¥–∏–Ω —Ä–∞–∑ –∑–∞ –∏–≥—Ä—É
    }
}

canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    flap();
}, {passive: false});

reset();
loop();
</script>
</body>
</html>
