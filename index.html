<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ghosty Shop Online</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #000; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; font-family: 'Press Start 2P', cursive; touch-action: none; -webkit-tap-highlight-color: transparent; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #0a0a1a url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/background-night.png') bottom center; background-size: cover; overflow: hidden; }
        
        /* –ü—Ä–∏–∑—Ä–∞–∫ */
        #bird { 
            position: absolute; width: 42px; height: 42px; z-index: 100;
            background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M20,80 Q20,20 50,20 Q80,20 80,80 Q70,70 60,80 Q50,70 40,80 Q30,70 20,80' fill='white'/><circle cx='40' cy='45' r='6' fill='%23ff69b4'/><circle cx='65' cy='45' r='6' fill='%23ff69b4'/></svg>") no-repeat;
            background-size: contain; filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
        }
        
        #hat-overlay { position: absolute; top: -18px; left: 5px; font-size: 22px; pointer-events: none; z-index: 101; }
        
        .pipe { position: absolute; width: 52px; background: url('https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/pipe-green.png') repeat-y; background-size: 52px auto; z-index: 50; border: 2px solid #000; filter: hue-rotate(260deg) brightness(0.6) saturate(1.5); }
        .pipe.top { transform: rotate(180deg); }
        
        #score-display { position: absolute; top: 10%; width: 100%; text-align: center; font-size: 35px; color: #fff; z-index: 200; display: none; text-shadow: 0 0 10px #9b59b6; }
        #currency-bar { position: absolute; top: 20px; left: 20px; color: #00d4ff; font-size: 10px; z-index: 1000; display: flex; align-items: center; gap: 5px; }

        .screen { position: absolute; inset: 0; background: rgba(10, 10, 30, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; color: #fff; }
        .leaderboard { background: #1a1a3a; border: 2px solid #9b59b6; padding: 12px; width: 260px; margin-bottom: 15px; font-size: 9px; }
        .row { display: flex; justify-content: space-between; margin: 6px 0; border-bottom: 1px solid #333; padding-bottom: 3px; }
        .row.me { color: #f1c40f; }

        .btn { background: #9b59b6; color: #fff; border: none; padding: 16px 25px; cursor: pointer; font-family: 'Press Start 2P', cursive; font-size: 12px; margin: 8px; box-shadow: 0 5px 0 #4a235a; width: 200px; }
        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #4a235a; }
        .btn-shop { background: #2980b9; box-shadow: 0 5px 0 #1a5276; }

        /* –ú–∞–≥–∞–∑–∏–Ω */
        #shop-screen { display: none; padding: 20px; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .shop-item { background: #1a1a3a; border: 2px solid #9b59b6; padding: 10px; text-align: center; position: relative; width: 110px; }
        .shop-item.selected { border-color: #00d4ff; background: #24244a; }
        .item-icon { font-size: 24px; margin-bottom: 8px; display: block; }
        .price { font-size: 8px; color: #00d4ff; }
    </style>
</head>
<body>
<div id="game-container">
    <div id="currency-bar">üíé <span id="orb-total">0</span></div>
    <div id="score-display">0</div>
    <div id="bird"><div id="hat-overlay"></div></div>
    
    <div id="menu" class="screen">
        <h2 style="font-size: 14px; color: #9b59b6;">GHOST TOP</h2>
        <div class="leaderboard" id="scores-list">Loading...</div>
        <button class="btn" id="start-btn">PLAY</button>
        <button class="btn btn-shop" id="open-shop">SHOP</button>
    </div>

    <div id="shop-screen" class="screen">
        <h2 style="font-size: 16px;">GHOST SHOP</h2>
        <div class="shop-grid">
            <div class="shop-item" onclick="selectHat('', 0)">
                <span class="item-icon">üëª</span>
                <span class="price">FREE</span>
            </div>
            <div class="shop-item" id="hat-crown" onclick="selectHat('üëë', 15)">
                <span class="item-icon">üëë</span>
                <span class="price">15 ORBS</span>
            </div>
            <div class="shop-item" id="hat-wizard" onclick="selectHat('üßô', 30)">
                <span class="item-icon">üßô</span>
                <span class="price">30 ORBS</span>
            </div>
            <div class="shop-item" id="hat-pirate" onclick="selectHat('üè¥‚Äç‚ò†Ô∏è', 50)">
                <span class="item-icon">üè¥‚Äç‚ò†Ô∏è</span>
                <span class="price">50 ORBS</span>
            </div>
        </div>
        <button class="btn" onclick="closeShop()">BACK</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const BASE_DB_URL = "https://birdgame-1649d-default-rtdb.firebaseio.com/users";
    const bird = document.getElementById('bird'), hatOverlay = document.getElementById('hat-overlay');
    const orbTotalDisp = document.getElementById('orb-total'), scoreDisplay = document.getElementById('score-display');
    
    let birdY, velocity, score, isRunning = false;
    let pipes = [], frameId;
    
    // –î–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
    let orbs = parseInt(localStorage.getItem('ghost_orbs')) || 0;
    let ownedHats = JSON.parse(localStorage.getItem('ghost_hats')) || [''];
    let currentHat = localStorage.getItem('ghost_current_hat') || '';
    
    const userId = tg.initDataUnsafe?.user?.id || "local_user";
    const firstName = tg.initDataUnsafe?.user?.first_name || "Ghost";

    orbTotalDisp.innerText = orbs;
    hatOverlay.innerText = currentHat;

    // --- –õ–û–ì–ò–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê ---
    function selectHat(emoji, price) {
        if (ownedHats.includes(emoji)) {
            currentHat = emoji;
            localStorage.setItem('ghost_current_hat', emoji);
            hatOverlay.innerText = emoji;
            tg.HapticFeedback.impactOccurred('light');
        } else if (orbs >= price) {
            orbs -= price;
            ownedHats.push(emoji);
            currentHat = emoji;
            localStorage.setItem('ghost_orbs', orbs);
            localStorage.setItem('ghost_hats', JSON.stringify(ownedHats));
            localStorage.setItem('ghost_current_hat', emoji);
            orbTotalDisp.innerText = orbs;
            hatOverlay.innerText = emoji;
            tg.HapticFeedback.notificationOccurred('success');
        } else {
            tg.HapticFeedback.notificationOccurred('error');
        }
        closeShop();
    }

    function openShop() { document.getElementById('shop-screen').style.display = 'flex'; }
    function closeShop() { document.getElementById('shop-screen').style.display = 'none'; }
    document.getElementById('open-shop').onclick = openShop;

    // --- –õ–û–ì–ò–ö–ê –ë–ê–ó–´ ---
    async function loadScores() {
        try {
            const res = await fetch(`${BASE_DB_URL}.json`);
            const data = await res.json();
            if (!data) return document.getElementById('scores-list').innerHTML = "No ghosts yet";
            const sorted = Object.values(data).sort((a,b) => b.score - a.score).slice(0, 5);
            document.getElementById('scores-list').innerHTML = sorted.map((r, i) => 
                `<div class="row ${r.id == userId ? 'me' : ''}"><span>#${i+1} ${r.name}</span><span>${r.score}</span></div>`
            ).join('');
        } catch(e) { console.error(e); }
    }

    async function saveScore(s) {
        const check = await fetch(`${BASE_DB_URL}/${userId}.json`);
        const current = await check.json();
        if (!current || s > current.score) {
            await fetch(`${BASE_DB_URL}/${userId}.json`, {
                method: 'PUT',
                body: JSON.stringify({ id: userId, name: firstName, score: s })
            });
        }
    }

    // --- –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ---
    function initGame() {
        if (isRunning) return;
        isRunning = true; score = 0; birdY = window.innerHeight/3; velocity = 0;
        pipes.forEach(p => { p.t.remove(); p.b.remove(); }); pipes = [];
        scoreDisplay.innerText = "0";
        scoreDisplay.style.display = 'block';
        document.getElementById('menu').style.display = 'none';
        requestAnimationFrame(update);
    }

    function update() {
        if (!isRunning) return;
        velocity += 0.22; birdY += velocity;
        bird.style.transform = `translateY(${birdY}px) rotate(${Math.min(velocity*4, 25)}deg)`;
        
        if (birdY > window.innerHeight - 100 || birdY < -50) return die();

        if (pipes.length === 0 || pipes[pipes.length-1].x < window.innerWidth - 240) {
            const gap = 180, topH = Math.random() * (window.innerHeight - 450) + 50;
            const t = document.createElement('div'); t.className = 'pipe top'; t.style.height = topH + 'px'; t.style.left = window.innerWidth + 'px';
            const b = document.createElement('div'); b.className = 'pipe bottom'; b.style.height = (window.innerHeight - topH - gap - 100) + 'px'; b.style.bottom = '100px'; b.style.left = window.innerWidth + 'px';
            document.getElementById('game-container').appendChild(t);
            document.getElementById('game-container').appendChild(b);
            pipes.push({x: window.innerWidth, t, b, p: false});
        }

        pipes.forEach((p, i) => {
            p.x -= 3; p.t.style.left = p.x + 'px'; p.b.style.left = p.x + 'px';
            const br = bird.getBoundingClientRect
