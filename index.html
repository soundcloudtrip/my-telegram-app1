<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #4ec0ca;
    font-family: 'Press Start 2P', cursive;
}

canvas {
    display: block;
    image-rendering: pixelated;
    touch-action: none;
}

#ui {
    position: absolute;
    inset: 0;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    align-items: center;
}

#score {
    margin-top: 30px;
    font-size: 32px;
    color: #fff;
    text-shadow: 4px 4px 0 #000;
    z-index: 5;
}

.screen {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    background: rgba(0,0,0,.35);
    pointer-events: auto;
    z-index: 10;
    border: 4px solid #000;
}

.pixel-btn {
    background: linear-gradient(#f97316,#e86101);
    color: #fff;
    border: 4px solid #543847;
    padding: 14px 36px;
    font-size: 14px;
    margin: 12px;
    box-shadow: 0 6px 0 #a04000, inset 0 -4px 0 #a04000;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.1s ease;
}

.pixel-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 7px 0 #a04000, inset 0 -4px 0 #a04000;
}

.pixel-btn:active {
    transform: translateY(3px);
    box-shadow: 0 3px 0 #a04000;
}
</style>
</head>

<body>

<div id="ui">
    <div id="score">0</div>

    <div id="startScreen" class="screen">
        <div style="color:#fff;font-size:18px;text-shadow:2px 2px #000;margin-bottom:20px;">FLAPPY PROMPT</div>
        <button class="pixel-btn" onclick="startGame()">PLAY</button>
    </div>

    <div id="gameOver" class="screen" style="display:none">
        <div style="color:#fff;font-size:18px;margin-bottom:20px;text-shadow:2px 2px #000;">GAME OVER</div>
        <button class="pixel-btn" onclick="reset()">RETRY</button>
    </div>
</div>

<canvas id="game"></canvas>

<script>
/* TELEGRAM */
const tg = window.Telegram.WebApp;
tg.expand();

/* CANVAS */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const BASE_W = 288;
const BASE_H = 512;
let scale = 1;

/* RESIZE */
function resize() {
    scale = Math.min(window.innerWidth / BASE_W, window.innerHeight / BASE_H);
    canvas.width = BASE_W * scale;
    canvas.height = BASE_H * scale;
}
window.addEventListener("resize", resize);
resize();

/* ASSETS */
const assets = { bg: new Image(), ground: new Image(), pipe: new Image(), bird: [] };
assets.bg.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/background-day.png";
assets.ground.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/base.png";
assets.pipe.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/pipe-green.png";
["upflap","midflap","downflap"].forEach((f,i)=>{
    assets.bird[i]=new Image();
    assets.bird[i].src=`https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/bluebird-${f}.png`;
});

/* GAME STATE */
let bird, pipes, score, gameActive, isDead, groundX, difficultyFactor;
const gravity = 0.35;
const flapPower = -4.2;
const maxFallSpeed = 7;
let pipeSpeed = 2.2;
let pipeGap = 125;

/* RESET */
function reset() {
    bird = {x:50,y:BASE_H/2,v:0,w:34,h:24};
    pipes = []; score = 0; gameActive=false; isDead=false; groundX=0; difficultyFactor=1;
    pipeSpeed = 2.2; pipeGap = 125;
    document.getElementById("score").innerText = score;
    document.getElementById("startScreen").style.display="flex";
    document.getElementById("gameOver").style.display="none";
}

/* START */
function startGame(){
    gameActive=true;
    document.getElementById("startScreen").style.display="none";
}

/* SPAWN PIPE */
function spawnPipe(){
    const margin=50;
    const maxTop=BASE_H - pipeGap - 112 - margin;
    const top=Math.random()*(maxTop-margin)+margin;
    pipes.push({x:BASE_W,top,passed:false});
}

/* UPDATE */
function update(){
    if(!gameActive) return;
    // Птица
    bird.v+=gravity;
    if(bird.v>maxFallSpeed) bird.v=maxFallSpeed;
    bird.y+=bird.v;

    // Появление труб
    if(pipes.length===0 || pipes[pipes.length-1].x < BASE_W-180) spawnPipe();

    // Коллизии и подсчёт очков
    pipes.forEach(p=>{
        p.x-=pipeSpeed;

        const hit = {x:bird.x+6,y:bird.y+6,w:bird.w-12,h:bird.h-12};

        if(hit.x<p.x+52 && hit.x+hit.w>p.x && (hit.y<p.top || hit.y+hit.h>p.top+pipeGap)) endGame();
        if(!p.passed && p.x+52<bird.x){p.passed=true;score++;document.getElementById("score").innerText=score;
            tg.HapticFeedback.impactOccurred('light'); 
            // Увеличиваем сложность каждые 30 очков
            if(score%30===0){pipeSpeed+=0.2; pipeGap=Math.max(90,pipeGap-5);}
        }
    });

    pipes=pipes.filter(p=>p.x>-60);

    if(bird.y+bird.h>BASE_H-112 || bird.y<0) endGame();

    // Скроллинг земли
    groundX-=pipeSpeed;
    if(groundX<=-BASE_W) groundX=0;
}

/* DRAW */
function draw(){
    ctx.setTransform(scale,0,0,scale,0,0);
    ctx.drawImage(assets.bg,0,0);
    pipes.forEach(p=>{
        // Верхняя труба
        ctx.save();
        ctx.translate(p.x+26,p.top);
        ctx.scale(1,-1);
        ctx.drawImage(assets.pipe,-26,0);
        ctx.restore();
        // Нижняя труба
        ctx.drawImage(assets.pipe,p.x,p.top+pipeGap);
    });
    const frame=Math.floor(Date.now()/140)%3;
    ctx.drawImage(assets.bird[frame],bird.x,bird.y);
    ctx.drawImage(assets.ground,groundX,BASE_H-112);
    ctx.drawImage(assets.ground,groundX+BASE_W,BASE_H-112);
}

/* GAME OVER */
function endGame(){
    if(isDead) return;
    isDead=true;
    gameActive=false;
    tg.HapticFeedback.notificationOccurred('error');
    document.getElementById("gameOver").style.display="flex";
}

/* INPUT */
window.addEventListener("touchstart",e=>{
    if(gameActive) bird.v=flapPower;
    if(e.target.tagName!=="BUTTON") e.preventDefault();
},{passive:false});
window.addEventListener("keydown",e=>{if(e.code==="Space" && gameActive) bird.v=flapPower;});

/* LOOP */
function loop(){update();draw();requestAnimationFrame(loop);}

reset(); loop();
</script>
</body>
</html>
