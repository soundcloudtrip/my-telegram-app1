<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ghosty Legend: Phaser Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #050508; overflow: hidden; }
        canvas { display: block; }
    </style>
</head>
<body>
<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.ready();

const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    backgroundColor: '#0a0a1a',
    physics: {
        default: 'arcade',
        arcade: { gravity: { y: 1200 }, debug: false }
    },
    scene: { preload: preload, create: create, update: update }
};

let game = new Phaser.Game(config);
let ghost, pipes, score = 0, scoreText, isGameOver = false;

function preload() {
    // Вшиваем спрайт призрака прямо в код (Base64)
    this.textures.addBase64('ghost', 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTIwIj48cGF0aCBkPSJNMjAsMTAwIEMyMCwyMCA1MCwyMCA4MCwyMCA4MCwxMDAgNzAsOTAgNjAsMTAwIDUwLDkwIDQwLDEwMCAzMCw5MCAyMCwxMDAiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjkiLz48Y2lyY2xlIGN4PSIzNSIgY3k9IjUwIiByPSI2IiBmaWxsPSJibGFjayIvPjxjaXJjbGUgY3g9IjY1IiBjeT0iNTAiIHI9IjYiIGZpbGw9ImJsYWNrIi8+PC9zdmc+');
}

function create() {
    const { width, height } = this.scale;

    // Фон с эффектом тумана
    let bg = this.add.graphics();
    bg.fillGradientStyle(0x0a0a1a, 0x0a0a1a, 0x1a0a2e, 0x1a0a2e, 1);
    bg.fillRect(0, 0, width, height);

    // Призрак
    ghost = this.physics.add.sprite(width * 0.2, height / 2, 'ghost').setScale(0.6);
    ghost.setCollideWorldBounds(false);
    ghost.setBodySize(60, 80);

    // Группа для колонн
    pipes = this.physics.add.group();

    // Таймер создания колонн
    this.time.addEvent({
        delay: 1500,
        callback: addPipes,
        callbackScope: this,
        loop: true
    });

    // Счет
    scoreText = this.add.text(width / 2, 50, '0', {
        fontSize: '48px',
        fontFamily: 'Arial Black',
        fill: '#fff'
    }).setOrigin(0.5).setShadow(0, 0, '#9b59b6', 15, false, true);

    // Управление
    this.input.on('pointerdown', () => {
        if (isGameOver) {
            this.scene.restart();
            isGameOver = false;
            score = 0;
        } else {
            ghost.setVelocityY(-400);
            this.tweens.add({
                targets: ghost,
                angle: -20,
                duration: 100,
                onComplete: () => { ghost.angle = 0; }
            });
        }
    });

    // Коллизии
    this.physics.add.overlap(ghost, pipes, () => hitPipe(this), null, this);
}

function update() {
    if (isGameOver) return;

    if (ghost.y > this.scale.height || ghost.y < -50) {
        hitPipe(this);
    }

    pipes.getChildren().forEach(pipe => {
        if (pipe.x < -100) pipe.destroy();
        if (!pipe.passed && pipe.x < ghost.x) {
            pipe.passed = true;
            if (pipe.name === 'top') { // Считаем очки только по одной колонне из пары
                score++;
                scoreText.setText(score);
                tg.HapticFeedback.impactOccurred('light');
            }
        }
    });
}

function addPipes() {
    if (isGameOver) return;

    const { width, height } = this.systems.scale;
    const gap = 200;
    const topH = Phaser.Math.Between(100, height - gap - 100);

    // Создаем верхнюю колонну
    let topPipe = pipes.create(width + 50, topH / 2, null);
    drawPipe(this, topPipe, topH, true);

    // Создаем нижнюю колонну
    let bottomPipe = pipes.create(width + 50, topH + gap + (height - topH - gap) / 2, null);
    drawPipe(this, bottomPipe, height - topH - gap, false);

    pipes.setVelocityX(-250);
}

function drawPipe(scene, pipe, h, isTop) {
    let graphics = scene.add.graphics();
    graphics.fillGradientStyle(0x1a1a1a, 0x333333, 0x1a1a1a, 0x333333, 1);
    graphics.fillRect(0, 0, 70, h);
    graphics.lineStyle(3, 0x4b0082, 1);
    graphics.strokeRect(0, 0, 70, h);
    
    // Генерируем текстуру из графики
    const key = 'pipe' + h + isTop;
    graphics.generateTexture(key, 70, h);
    graphics.destroy();

    pipe.setTexture(key);
    pipe.body.setAllowGravity(false);
    pipe.body.setImmovable(true);
    pipe.name = isTop ? 'top' : 'bottom';
    pipe.passed = false;
}

function hitPipe(scene) {
    isGameOver = true;
    scene.physics.pause();
    ghost.setTint(0xff0000);
    tg.HapticFeedback.notificationOccurred('error');
    
    scene.add.text(scene.scale.width / 2, scene.scale.height / 2, 'GAME OVER\nTap to Restart', {
        fontSize: '32px',
        fill: '#fff',
        align: 'center',
        fontFamily: 'Arial Black'
    }).setOrigin(0.5);
}
</script>
</body>
</html>
