<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flappy Prompt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
html, body {
    margin: 0;
    padding: 0;
    background: black;
    overflow: hidden;
}
canvas {
    display: block;
    margin: auto;
}
#ui {
    position: absolute;
    inset: 0;
    pointer-events: none;
}
#score {
    position: absolute;
    top: 20px;
    width: 100%;
    text-align: center;
    font-size: 42px;
    font-weight: bold;
    color: white;
    text-shadow: 3px 3px 0 #000;
}
#startScreen, #gameOver {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    background: rgba(0,0,0,.35);
    color: white;
}
#startScreen h1 {
    font-size: 32px;
    margin-bottom: 10px;
}
#startScreen p {
    opacity: .8;
}
button {
    pointer-events: auto;
    margin-top: 12px;
    padding: 10px 22px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    background: #facc15;
}
</style>
</head>
<body>

<div id="ui">
    <div id="score">0</div>

    <div id="startScreen">
        <h1>Flappy Prompt</h1>
        <p>Tap to start</p>
    </div>

    <div id="gameOver" style="display:none">
        <h2>Game Over</h2>
        <p id="finalScore"></p>
        <h3>üèÜ Top 5</h3>
        <ol id="leaders"></ol>
        <button onclick="reset()">Play again</button>
    </div>
</div>

<canvas id="game"></canvas>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const BASE_W = 288;
const BASE_H = 512;
const GROUND_H = 112;

let scale = 1;

function resize() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    scale = Math.min(w / BASE_W, h / BASE_H);
    canvas.width = BASE_W * scale;
    canvas.height = BASE_H * scale;
    ctx.setTransform(scale, 0, 0, scale, 0, 0);
}
window.addEventListener("resize", resize);
resize();

const user = tg.initDataUnsafe?.user;
const username = user?.username || "Anonymous";

const assets = {
    bg: new Image(),
    ground: new Image(),
    pipe: new Image(),
    bird: []
};

assets.bg.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/background-day.png";
assets.ground.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/base.png";
assets.pipe.src = "https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/pipe-green.png";
["upflap","midflap","downflap"].forEach((f,i)=>{
    assets.bird[i] = new Image();
    assets.bird[i].src =
        `https://raw.githubusercontent.com/sourabhv/FlapPyBird/master/assets/sprites/bluebird-${f}.png`;
});

let bird, pipes, score, started, gameOver;
let lastTime = 0;

function reset() {
    bird = { x: 60, y: 240, v: 0 };
    pipes = [];
    score = 0;
    started = false;
    gameOver = false;
    document.getElementById("score").innerText = score;
    document.getElementById("startScreen").style.display = "flex";
    document.getElementById("gameOver").style.display = "none";
}

function addPipe() {
    const gap = 100;
    const top = Math.random() * 150 + 50;
    pipes.push({
        x: BASE_W,
        top,
        bottom: top + gap,
        passed: false
    });
}

function update(dt) {
    if (!started || gameOver) return;

    bird.v += 1200 * dt;
    bird.y += bird.v * dt;

    if (pipes.length === 0 || pipes[pipes.length - 1].x < 140)
        addPipe();

    pipes.forEach(p => {
        p.x -= 120 * dt;

        if (!p.passed && p.x + 52 < bird.x) {
            p.passed = true;
            score++;
            document.getElementById("score").innerText = score;
        }

        if (
            bird.x + 17 > p.x &&
            bird.x < p.x + 52 &&
            (bird.y < p.top || bird.y + 12 > p.bottom)
        ) endGame();
    });

    pipes = pipes.filter(p => p.x > -60);

    if (bird.y > BASE_H - GROUND_H - 12 || bird.y < 0)
        endGame();
}

function draw() {
    ctx.drawImage(assets.bg, 0, 0);
    pipes.forEach(p => {
        ctx.save();
        ctx.translate(p.x + 26, p.top);
        ctx.scale(1, -1);
        ctx.drawImage(assets.pipe, -26, 0);
        ctx.restore();
        ctx.drawImage(assets.pipe, p.x, p.bottom);
    });

    ctx.drawImage(
        assets.bird[Math.floor(Date.now()/100)%3],
        bird.x,
        bird.y
    );

    ctx.drawImage(assets.ground, 0, BASE_H - GROUND_H);
}

function loop(time) {
    const dt = Math.min((time - lastTime) / 1000, 0.02);
    lastTime = time;
    update(dt);
    draw();
    requestAnimationFrame(loop);
}

function flap() {
    if (!started) {
        started = true;
        document.getElementById("startScreen").style.display = "none";
    }
    if (!gameOver) bird.v = -350;
}

function endGame() {
    gameOver = true;
    saveScore();
    showLeaders();
    document.getElementById("finalScore").innerText = "Score: " + score;
    document.getElementById("gameOver").style.display = "flex";
}

function saveScore() {
    tg.CloudStorage.getItem("scores", (e, d) => {
        let s = d ? JSON.parse(d) : [];
        s.push({ name: username, score });
        s.sort((a,b)=>b.score-a.score);
        tg.CloudStorage.setItem("scores", JSON.stringify(s.slice(0,5)));
    });
}

function showLeaders() {
    const list = document.getElementById("leaders");
    list.innerHTML = "";
    tg.CloudStorage.getItem("scores", (e,d)=>{
        if (!d) return;
        JSON.parse(d).forEach(r=>{
            const li = document.createElement("li");
            li.textContent = `${r.name}: ${r.score}`;
            list.appendChild(li);
        });
    });
}

canvas.addEventListener("click", flap);
document.addEventListener("keydown", e=>e.code==="Space"&&flap());

reset();
requestAnimationFrame(loop);
</script>
</body>
</html>
