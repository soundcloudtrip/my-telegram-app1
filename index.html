<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CodeGram Flappy Bird</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #111; overflow: hidden; font-family: 'Press Start 2P', cursive; touch-action: none; -webkit-tap-highlight-color: transparent; }
        canvas { display: block; margin: 0 auto; background: #70c5ce; }
        
        #ui-layer { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; pointer-events: none; }
        .menu-box { 
            background: rgba(0, 0, 0, 0.9); padding: 20px; border: 4px solid #f1c40f; 
            text-align: center; color: white; pointer-events: auto; width: 280px; border-radius: 15px;
        }
        
        button {
            background: #e67e22; border: none; border-bottom: 4px solid #d35400;
            color: white; font-family: 'Press Start 2P', cursive; padding: 12px;
            font-size: 10px; cursor: pointer; margin: 10px 0; width: 100%; transition: 0.1s;
        }
        button:active { transform: translateY(2px); border-bottom-width: 2px; }

        .btn-channel { background: #3498db; border-bottom-color: #2980b9; font-size: 9px; }

        .leaderboard { margin-top: 10px; font-size: 8px; text-align: left; }
        .score-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px solid #333; }
        .title { color: #f1c40f; font-size: 14px; margin-bottom: 10px; }
        #game-score { position: absolute; top: 40px; width: 100%; text-align: center; color: white; font-size: 30px; text-shadow: 3px 3px 0 #000; z-index: 50; display: none; }
        
        /* –°—Ç–∞—Ç—É—Å –±–æ–Ω—É—Å–∞ */
        #bonus-status { font-size: 8px; color: #2ecc71; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div id="game-score">0</div>

<div id="ui-layer">
    <div id="main-menu" class="menu-box">
        <div class="title">CODEGRAM BIRD</div>
        
        <button class="btn-channel" onclick="joinChannel()">üì¢ –ü–û–î–ü–ò–°–ê–¢–¨–°–Ø (+–©–ò–¢)</button>
        <div id="bonus-status">‚úÖ –©–ò–¢ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù</div>
        
        <button onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
        
        <div id="start-leaderboard" class="leaderboard"></div>
    </div>

    <div id="death-menu" class="menu-box" style="display: none;">
        <div class="title" style="color: #e74c3c;">GAME OVER</div>
        <div id="final-score" style="font-size: 12px; margin-bottom: 10px;"></div>
        <button onclick="startGame()">–†–ï–°–¢–ê–†–¢</button>
        <button class="btn-channel" onclick="joinChannel()">–ö–ê–ù–ê–õ CodeGram</button>
        <div id="end-leaderboard" class="leaderboard"></div>
    </div>
</div>

<canvas id="game"></canvas>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ—é —Å—Å—ã–ª–∫—É
    const CHANNEL_URL = "https://t.me/your_channel_username"; 

    const firebaseConfig = {
        apiKey: "AIzaSyBZnG_M4EG1H8RKLhJJ9GIbZpipurLTpAs",
        databaseURL: "https://birdgame-1649d-default-rtdb.firebaseio.com",
        projectId: "birdgame-1649d",
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('game-score');
    const bonusStatus = document.getElementById('bonus-status');
    
    const mainMenu = document.getElementById('main-menu');
    const deathMenu = document.getElementById('death-menu');

    let W, H, bird, pipes, score, isPlay = false, frame = 0, pipeSpeed = 3;
    let hasShield = false; // –§–ª–∞–≥ —â–∏—Ç–∞

    const birdImg = new Image(); birdImg.src = 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/yellowbird-midflap.png';
    const bgImg = new Image(); bgImg.src = 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/background-day.png';
    const pipeImg = new Image(); pipeImg.src = 'https://raw.githubusercontent.com/samuelcust/flappy-bird-assets/master/sprites/pipe-green.png';

    function resize() {
        W = canvas.width = Math.min(window.innerWidth, 400); 
        H = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    updateLeaderboardDisplay('start-leaderboard');

    function joinChannel() {
        tg.openTelegramLink(CHANNEL_URL);
        hasShield = true; // –î–∞–µ–º –±–æ–Ω—É—Å –∑–∞ –∫–ª–∏–∫
        bonusStatus.style.display = 'block';
        tg.HapticFeedback.notificationOccurred('success');
    }

    function startGame() {
        mainMenu.style.display = 'none';
        deathMenu.style.display = 'none';
        scoreEl.style.display = 'block';
        
        bird = { y: H/2, v: 0, g: 0.25, w: 34, h: 24, shield: hasShield };
        pipes = []; score = 0; frame = 0;
        scoreEl.innerText = "0";
        isPlay = true;
        
        requestAnimationFrame(loop);
    }

    function loop() {
        if(!isPlay) return;

        bird.v += bird.g;
        bird.y += bird.v;

        if (frame % 95 === 0) {
            let gap = 160;
            let topHeight = Math.random() * (H - gap - 200) + 100;
            pipes.push({ x: W, top: topHeight, gap: gap, passed: false });
        }

        for(let i = pipes.length - 1; i >= 0; i--) {
            let p = pipes[i];
            p.x -= pipeSpeed;

            // –ö–æ–ª–ª–∏–∑–∏—è
            if (65 + bird.w - 5 > p.x && 65 + 5 < p.x + 52) {
                if (bird.y + 5 < p.top || bird.y + bird.h - 5 > p.top + p.gap) {
                    if (bird.shield) {
                        bird.shield = false; // –¢—Ä–∞—Ç–∏–º —â–∏—Ç
                        hasShield = false; 
                        bonusStatus.style.display = 'none';
                        pipes.splice(i, 1); // –£–¥–∞–ª—è–µ–º —Ç—Ä—É–±—É, —á—Ç–æ–±—ã –Ω–µ –±–∏—Ç—å—Å—è –æ–± –Ω–µ–µ —Å–Ω–æ–≤–∞
                        tg.HapticFeedback.notificationOccurred('warning');
                        continue;
                    }
                    gameOver();
                }
