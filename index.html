<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel Fly TG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --sky-color: #4ec0ca;
            --pipe-green: #73bf2e;
            --pipe-dark: #558022;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: none; /* Убирает все задержки браузера */
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: var(--sky-color);
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 20% 30%, white 2%, transparent 3%),
                radial-gradient(circle at 80% 20%, white 4%, transparent 5%),
                linear-gradient(to bottom, #4ec0ca 0%, #d2eaf0 100%);
        }

        /* Детальная птица */
        #bird {
            position: absolute;
            width: 38px;
            height: 28px;
            background: #f8e71c;
            border: 3px solid #000;
            border-radius: 50% 50% 40% 40%;
            z-index: 10;
            will-change: transform; /* Оптимизация скорости */
        }
        #bird::after { /* Глаз */
            content: '';
            position: absolute;
            top: 5px; right: 5px;
            width: 8px; height: 8px;
            background: white; border: 2px solid black; border-radius: 50%;
        }
        #bird::before { /* Крыло */
            content: '';
            position: absolute;
            top: 10px; left: -5px;
            width: 15px; height: 10px;
            background: #fff; border: 2px solid black; border-radius: 40%;
        }

        /* Детальные трубы */
        .pipe {
            position: absolute;
            width: 60px;
            background: linear-gradient(90deg, var(--pipe-dark) 0%, var(--pipe-green) 20%, var(--pipe-green) 80%, var(--pipe-dark) 100%);
            border: 3px solid #000;
            z-index: 5;
        }
        .pipe-cap {
            position: absolute;
            width: 70px;
            height: 25px;
            left: -8px;
            background: linear-gradient(90deg, var(--pipe-dark) 0%, var(--pipe-green) 20%, var(--pipe-green) 80%, var(--pipe-dark) 100%);
            border: 3px solid #000;
        }
        .top .pipe-cap { bottom: -3px; }
        .bottom .pipe-cap { top: -3px; }

        /* Декорации (Город на фоне) */
        #city {
            position: absolute;
            bottom: 60px;
            width: 200%;
            height: 100px;
            background-image: repeating-linear-gradient(90deg, #5fb2bb 0, #5fb2bb 40px, transparent 40px, transparent 80px);
            opacity: 0.5;
            animation: moveCity 20s linear infinite;
        }

        @keyframes moveCity {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        #ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60px;
            background: #ded895;
            border-top: 4px solid #558022;
            z-index: 15;
            background-image: repeating-linear-gradient(45deg, #d3ca7b 0, #d3ca7b 10px, #ded895 10px, #ded895 20px);
        }

        #score {
            position: absolute;
            top: 50px;
            width: 100%;
            text-align: center;
            font-size: 60px;
            font-weight: bold;
            color: #fff;
            text-shadow: 4px 4px 0 #000;
            z-index: 20;
        }

        .screen {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
            text-align: center;
        }

        .btn {
            padding: 15px 40px;
            font-size: 24px;
            background: #ff8c00;
            color: white;
            border: 4px solid #fff;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 5px 0 #b36200;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="city"></div>
    <div id="score">0</div>
    <div id="bird"></div>
    <div id="ground"></div>

    <div id="start-screen" class="screen">
        <h1 style="font-size: 40px; margin-bottom: 0;">PIXEL FLY</h1>
        <p>Тапай, чтобы лететь</p>
        <button class="btn" onclick="startGame()">ИГРАТЬ</button>
    </div>

    <div id="over-screen" class="screen" style="display: none;">
        <h1 style="color: #ff4444;">GAME OVER</h1>
        <p id="final-score" style="font-size: 24px;">Счет: 0</p>
        <button class="btn" onclick="startGame()">ЕЩЕ РАЗ</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    const bird = document.getElementById('bird');
    const container = document.getElementById('game-container');
    const scoreText = document.getElementById('score');
    
    let birdY = 300;
    let velocity = 0;
    let gravity = 0.25;
    let jump = -5.5;
    let score = 0;
    let isGameRunning = false;
    let pipes = [];
    let frameId;

    function startGame() {
        isGameRunning = true;
        score = 0;
        birdY = window.innerHeight / 2;
        velocity = 0;
        scoreText.innerText = "0";
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('over-screen').style.display = 'none';
        
        // Очистка старых труб
        pipes.forEach(p => p.top.remove() || p.bottom.remove());
        pipes = [];
        
        requestAnimationFrame(update);
    }

    function createPipe() {
        const gap = 160;
        const minPipeHeight = 50;
        const maxPipeHeight = window.innerHeight - gap - minPipeHeight - 100;
        const topHeight = Math.floor(Math.random() * maxPipeHeight) + minPipeHeight;

        const topPipe = document.createElement('div');
        topPipe.className = 'pipe top';
        topPipe.style.height = topHeight + 'px';
        topPipe.style.left = window.innerWidth + 'px';
        topPipe.innerHTML = '<div class="pipe-cap"></div>';

        const bottomPipe = document.createElement('div');
        bottomPipe.className = 'pipe bottom';
        bottomPipe.style.height = (window.innerHeight - topHeight - gap - 60) + 'px';
        bottomPipe.style.bottom = '60px';
        bottomPipe.style.left = window.innerWidth + 'px';
        bottomPipe.innerHTML = '<div class="pipe-cap"></div>';

        container.appendChild(topPipe);
        container.appendChild(bottomPipe);

        pipes.push({
            x: window.innerWidth,
            top: topPipe,
            bottom: bottomPipe,
            passed: false
        });
    }

    function update() {
        if (!isGameRunning) return;

        velocity += gravity;
        birdY += velocity;
        bird.style.transform = `translateY(${birdY}px) rotate(${Math.min(velocity * 4, 90)}deg)`;

        // Проверка столкновения с полом/потолком
        if (birdY > window.innerHeight - 88 || birdY < 0) return gameOver();

        // Управление трубами
        if (pipes.length === 0 || pipes[pipes.length - 1].x < window.innerWidth - 200) {
            createPipe();
        }

        pipes.forEach((pipe, index) => {
            pipe.x -= 3.5; // Скорость труб
            pipe.top.style.left = pipe.x + 'px';
            pipe.bottom.style.left = pipe.x + 'px';

            // Столкновение с трубами
            const birdRect = bird.getBoundingClientRect();
            const topRect = pipe.top.getBoundingClientRect();
            const botRect = pipe.bottom.getBoundingClientRect();

            if (birdRect.right > topRect.left && birdRect.left < topRect.right) {
                if (birdRect.top < topRect.bottom || birdRect.bottom > botRect.top) {
                    gameOver();
                }
            }

            // Очки
            if (!pipe.passed && pipe.x < 50) {
                pipe.passed = true;
                score++;
                scoreText.innerText = score;
                tg.HapticFeedback.impactOccurred('medium');
            }

            // Удаление труб
            if (pipe.x < -100) {
                pipe.top.remove();
                pipe.bottom.remove();
                pipes.splice(index, 1);
            }
        });

        frameId = requestAnimationFrame(update);
    }

    function gameOver() {
        isGameRunning = false;
        cancelAnimationFrame(frameId);
        tg.HapticFeedback.notificationOccurred('error');
        document.getElementById('over-screen').style.display = 'flex';
        document.getElementById('final-score').innerText = "Счет: " + score;
    }

    // Мгновенный прыжок
    const handleAction = (e) => {
        if (!isGameRunning) return;
        velocity = jump;
        tg.HapticFeedback.impactOccurred('light');
        e.preventDefault();
    };

    window.addEventListener('touchstart', handleAction, { passive: false });
    window.addEventListener('mousedown', (e) => {
        if (e.button === 0) handleAction(e);
    });
</script>
</body>
</html>
