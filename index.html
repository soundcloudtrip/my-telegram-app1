<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ghosty: Dark Fantasy Fixed</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050508;
            --accent-purple: #4b0082;
            --neon-blue: #00d4ff;
        }

        body { margin: 0; padding: 0; background: var(--bg-dark); overflow: hidden; font-family: 'Press Start 2P', cursive; touch-action: none; color: white; -webkit-user-select: none; }
        
        #game-container { position: relative; width: 100vw; height: 100vh; background: #0a0a1a; overflow: hidden; }

        /* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å–ª–æ–∏ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û pointer-events: none */
        #background-layer {
            position: absolute; bottom: 0; width: 200%; height: 50%;
            background: url('https://img.freepik.com/free-vector/pixel-art-castle-night_52683-122416.jpg') repeat-x bottom;
            background-size: contain; opacity: 0.2; pointer-events: none; z-index: 1;
        }

        #fog-layer {
            position: absolute; inset: 0;
            background: radial-gradient(circle at 50% 100%, rgba(75, 0, 130, 0.3), transparent 70%);
            pointer-events: none; z-index: 2;
        }

        /* –ü—Ä–∏–∑—Ä–∞–∫ */
        #bird { 
            position: absolute; width: 45px; height: 45px; z-index: 100; left: 60px;
            background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M20,80 Q20,20 50,20 Q80,20 80,80 Q70,70 60,80 Q50,70 40,80 Q30,70 20,80' fill='white' opacity='0.9'/><circle cx='35' cy='45' r='5' fill='black'/><circle cx='65' cy='45' r='5' fill='black'/></svg>") no-repeat;
            background-size: contain; display: none; pointer-events: none;
        }
        #hat-overlay { position: absolute; top: -15px; left: 5px; font-size: 26px; z-index: 101; pointer-events: none; }

        /* –°–∫–∏–Ω—ã */
        .skin-default { filter: drop-shadow(0 0 10px #fff); }
        .skin-cyber { filter: drop-shadow(0 0 15px #bc13fe) hue-rotate(280deg); }
        .skin-viking { filter: drop-shadow(0 0 10px #888) sepia(0.5); }
        .skin-royal { filter: drop-shadow(0 0 15px #ffd700); }
        .skin-ninja { filter: grayscale(1) brightness(0.4) drop-shadow(0 0 5px #fff); }

        /* –ö–æ–ª–æ–Ω–Ω—ã */
        .pipe { position: absolute; width: 60px; z-index: 50; background: #1a1a1a; border-left: 4px solid #4b0082; border-right: 4px solid #4b0082; pointer-events: none; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #score-display { position: absolute; top: 10%; width: 100%; text-align: center; font-size: 30px; z-index: 200; display: none; text-shadow: 0 0 10px #000; pointer-events: none; }
        #currency { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 10px; border: 2px solid var(--accent-purple); border-radius: 12px; color: var(--neon-blue); font-size: 10px; z-index: 1000; pointer-events: none; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { 
            background: var(--accent-purple); color: white; border: none; 
            padding: 20px; cursor: pointer; font-family: inherit; font-size: 12px; 
            margin: 10px; width: 240px; border-bottom: 5px solid #300050;
            pointer-events: auto !important; /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ */
            position: relative; z-index: 2001;
        }
        .btn:active { transform: translateY(3px); border-bottom: 2px solid #300050; }

        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; pointer-events: auto; }
        .shop-item { background: #111; border: 2px solid #333; padding: 10px; width: 110px; text-align: center; cursor: pointer; pointer-events: auto; }
        .shop-item.equipped { border-color: var(--neon-blue); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="background-layer"></div>
    <div id="fog-layer"></div>
    
    <div id="currency">üíé <span id="orb-count">0</span></div>
    <div id="score-display">0</div>
    <div id="bird"><div id="hat-overlay"></div></div>

    <div id="menu" class="screen">
        <h1 style="color:var(--accent-purple); font-size:16px; margin-bottom:20px;">NEON CRYPT</h1>
        <div id="leaderboard" style="font-size:8px; background:#111; padding:10px; width:240px; border:1px solid #333; margin-bottom:20px; pointer-events:none;">
            Loading...
        </div>
        <button class="btn" id="play-btn">START GAME</button>
        <button class="btn" id="shop-btn" style="background:#2980b9; border-bottom-color:#1a5276;">SHOP</button>
    </div>

    <div id="shop" class="screen" style="display:none">
        <h2 style="font-size:12px;">SKINS</h2>
        <div class="shop-grid" id="shop-items"></div>
        <button class="btn" id="back-btn">BACK</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const DB_URL = "https://birdgame-1649d-default-rtdb.firebaseio.com/users";
    const bird = document.getElementById('bird'), hat = document.getElementById('hat-overlay');
    const scoreDisp = document.getElementById('score-display'), orbDisp = document.getElementById('orb-count');
    
    let birdY, vel, score, isPlay = false, pipes = [], loop;
    let orbs = parseInt(localStorage.getItem('gh_orbs_v2')) || 0;
    let mySkins = JSON.parse(localStorage.getItem('gh_skins_v2')) || ['DEFAULT'];
    let curSkin = localStorage.getItem('gh_cur_skin_v2') || 'DEFAULT';

    const skinList = [
        { id: 'DEFAULT', name: 'SOUL', emoji: '', price: 0, class: 'skin-default' },
        { id: 'CYBER', name: 'CYBER', emoji: 'üï∂Ô∏è', price: 20, class: 'skin-cyber' },
        { id: 'VIKING', name: 'VIKING', emoji: 'ü™ñ', price: 40, class: 'skin-viking' },
        { id: 'ROYAL', name: 'ROYAL', emoji: 'üëë', price: 80, class: 'skin-royal' },
        { id: 'NINJA', name: 'NINJA', emoji: 'ü•∑', price: 120, class: 'skin-ninja' }
    ];

    function updateStats() {
        orbDisp.innerText = orbs;
        const s = skinList.find(x => x.id === curSkin);
        bird.className = s.class;
        hat.innerText = s.emoji;
    }

    function renderShop() {
        const container = document.getElementById('shop-items');
        container.innerHTML = skinList.map(s => {
            const owned = mySkins.includes(s.id);
            const active = curSkin === s.id;
            return `
                <div class="shop-item ${active ? 'equipped' : ''}" onclick="selectSkin('${s.id}')">
                    <div style="font-size:20px">${s.emoji || 'üëª'}</div>
                    <div style="font-size:7px; margin:5px 0;">${s.name}</div>
                    <div style="font-size:8px; color:#00d4ff">${owned ? (active ? 'USE' : 'OWN') : s.price+'üíé'}</div>
                </div>
            `;
        }).join('');
    }

    window.selectSkin = (id) => {
        const s = skinList.find(x => x.id === id);
        if (mySkins.includes(id)) {
            curSkin = id;
            tg.HapticFeedback.impactOccurred('light');
        } else if (orbs >= s.price) {
            orbs -= s.price;
            mySkins.push(id);
            curSkin = id;
            tg.HapticFeedback.notificationOccurred('success');
        }
        localStorage.setItem('gh_orbs_v2', orbs);
        localStorage.setItem('gh_skins_v2', JSON.stringify(mySkins));
        localStorage.setItem('gh_cur_skin_v2', curSkin);
        updateStats(); renderShop();
    };

    // –°–æ–±—ã—Ç–∏—è –∫–Ω–æ–ø–æ–∫ (–ü—Ä—è–º–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ)
    document.getElementById('play-btn').onclick = () => startGame();
    document.getElementById('shop-btn').onclick = () => { document.getElementById('shop').style.display='flex'; renderShop(); };
    document.getElementById('back-btn').onclick = () => { document.getElementById('shop').style.display='none'; };

    function startGame() {
        isPlay = true; score = 0; birdY = window.innerHeight/2; vel = 0;
        pipes.forEach(p => { p.t.remove(); p.b.remove(); }); pipes = [];
        scoreDisp.innerText = "0"; scoreDisp.style.display = 'block';
        document.getElementById('menu').style.display = 'none';
        bird.style.display = 'block'; updateStats();
        requestAnimationFrame(gameLoop);
    }

    function gameLoop() {
        if (!isPlay) return;
        vel += 0.25; birdY += vel;
        bird.style.top = birdY + 'px';
        bird.style.transform = `rotate(${Math.min(vel*3, 25)}deg)`;
        
        if (birdY > window.innerHeight - 50 || birdY < -20) return gameOver();

        if (pipes.length === 0 || pipes[pipes.length-1].x < window.innerWidth - 220) {
            const gap = 180;
            const topH = Math.random() * (window.innerHeight - gap - 200) + 60;
            const botH = window.innerHeight - topH - gap;
            const t = document.createElement('div'); t.className = 'pipe'; t.style.height = topH + 'px'; t.style.top = '0'; t.style.left = window.innerWidth + 'px';
            const b = document.createElement('div'); b.className = 'pipe'; b.style.height = botH + 'px'; b.style.bottom = '0'; b.style.left = window.innerWidth + 'px';
            document.getElementById('game-container').appendChild(t); document.getElementById('game-container').appendChild(b);
            pipes.push({x: window.innerWidth, t, b, pass: false});
        }

        pipes.forEach((p, i) => {
            p.x -= 3.5; p.t.style.left = p.x + 'px'; p.b.style.left = p.x + 'px';
            const br = bird.getBoundingClientRect(), tr = p.t.getBoundingClientRect(), brr = p.b.getBoundingClientRect();
            if (br.right-10 > tr.left && br.left+10 < tr.right && (br.top+10 < tr.bottom || br.bottom-10 > brr.top)) gameOver();
            if (!p.pass && p.x < 60) { 
                p.pass = true; score++; orbs++; 
                scoreDisp.innerText = score; orbDisp.innerText = orbs;
                localStorage.setItem('gh_orbs_v2', orbs);
                tg.HapticFeedback.impactOccurred('medium'); 
            }
            if (p.x < -80) { p.t.remove(); p.b.remove(); pipes.splice(i, 1); }
        });
        loop = requestAnimationFrame(gameLoop);
    }

    function gameOver() {
        isPlay = false; cancelAnimationFrame(loop);
        tg.HapticFeedback.notificationOccurred('error');
        document.getElementById('menu').style.display = 'flex';
        scoreDisp.style.display = 'none'; bird.style.display = 'none';
        saveScore();
    }

    async function saveScore() {
        const uid = tg.initDataUnsafe?.user?.id || "local";
        const name = tg.initDataUnsafe?.user?.first_name || "Ghost";
        try {
            await fetch(`${DB_URL}/${uid}.json`, { method: 'PATCH', body: JSON.stringify({name: name, score: score})});
            loadBoard();
        } catch(e) {}
    }

    async function loadBoard() {
        try {
            const r = await fetch(`${DB_URL}.json`);
            const d = await r.json();
            if(!d) return;
            const top = Object.values(d).sort((a,b) => b.score - a.score).slice(0, 5);
            document.getElementById('leaderboard').innerHTML = top.map((p, i) => 
                `<div style="display:flex; justify-content:space-between; margin:3px 0;"><span>#${i+1} ${p.name}</span><span>${p.score}</span></div>`
            ).join('');
        } catch(e) {}
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ø—Ä—ã–∂–æ–∫)
    const handleJump = (e) => { 
        if(isPlay) {
            vel = -5.3; 
            if(e.type === 'touchstart') e.preventDefault(); 
        }
    };
    window.addEventListener('touchstart', handleJump, {passive: false});
    window.addEventListener('mousedown', handleJump);

    updateStats(); loadBoard();
</script>
</body>
</html>
